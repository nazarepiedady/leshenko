{"commits": [{"oid": "fc22786346f9f39e8c396f82b1d9c1d18c5ffbc8", "id": "write-tree-create-tree-obj", "title": "write-tree: Write tree objects", "message": "<p>Now comes the fun part, where we turn a collection of separate files into a single object that represents a directory.</p>\n<p>The idea is that we will create one additional object that collects all the data necessary to store a complete directory. For example, if we have a directory with two files:</p>\n<pre><code>$ ls\ncats.txt    dogs.txt</code></pre>\n<p>And we want to save the directory, we will first put the individual files into the object database:</p>\n<pre><code>$ ugit hash-object cats.txt\n91a7b14a584645c7b995100223e65f8a5a33b707\n$ ugit hash-object dogs.txt\nfa958e0dd2203e9ad56853a3f51e5945dad317a4</code></pre>\n<p>Then we will create a <strong>\"tree\"</strong> object that has the content of:</p>\n<pre><code>91a7b14a584645c7b995100223e65f8a5a33b707 cats.txt\nfa958e0dd2203e9ad56853a3f51e5945dad317a4 dogs.txt</code></pre>\n<p>And we will put this tree object into the object database as well. Then the OID of the tree object will actually represent the entire directory! Why? Because we can first retrieve the tree object by its OID, then see all the files it contains (their names and OIDs) and then read all the OIDs of the files to get their actual content.</p>\n<p>What if our directory contains other directories? We'll just create tree objects for them as well and we'll allow one tree object to point to another:</p>\n<pre><code>$ ls\ncats.txt    dogs.txt    other/\n$ ls other/\nshoes.jpg</code></pre>\n<p>The root tree object will look like this:</p>\n<pre><code>blob 91a7b14a584645c7b995100223e65f8a5a33b707 cats.txt\nblob fa958e0dd2203e9ad56853a3f51e5945dad317a4 dogs.txt\ntree 53891a3c27b17e0f8fd96c058f968d19e340428d other</code></pre>\n<p>Note that we added a type to each entry so that we know if it's a file or a directory. The tree that represents the \"other\" directory (OID 53891a3c27b17e0f8fd96c058f968d19e340428d) looks like:</p>\n<pre><code>blob 0aa186b09fd81e8cf449ba10eee6aff9711cc1ac shoes.jpg</code></pre>\n<p>We can think about this structure as a tree you know from Computer Science where each entries' OID as a pointer to either another tree or to a file (leaf node).</p>\n<p>Note that we actually save the tree objects with type \"tree\" in <code>data.hash_object()</code> since we don't want the trees to be confused with regular files.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [7, 15, 17, 19, 20, 21, 23, 24, 25, 26], "hunks": [{"title": "@@ -4,6 +4,7 @@ from . import data", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"7\"><span class=\"d-s\">+ </span>    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"d-s\">  </span>    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"d-s\">  </span>        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"d-s\">  </span>            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span></code></pre></div>\n"}, {"title": "@@ -11,12 +12,18 @@ def write_tree (directory='.'):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"12\"><span class=\"d-s\">  </span>                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"13\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"14\"><span class=\"d-s\">  </span>            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"15\"><span class=\"d-s\">+ </span>                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"16\"><span class=\"d-s\">  </span>                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>                    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()),</span> <span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"17\"><span class=\"d-s\">+ </span>                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"18\"><span class=\"d-s\">  </span>            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"19\"><span class=\"d-s\">- </span>                <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"19\"><span class=\"d-s\">+ </span>                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line d-a\" data-line=\"20\"><span class=\"d-s\">+ </span>                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"21\"><span class=\"d-s\">+ </span>            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"22\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"23\"><span class=\"d-s\">- </span>    <span class=\"c1\"># TODO actually create the tree object</span>\n</span><span class=\"line d-a\" data-line=\"23\"><span class=\"d-s\">+ </span>    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"24\"><span class=\"d-s\">+ </span>                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line d-a\" data-line=\"25\"><span class=\"d-s\">+ </span>                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"26\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"28\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"29\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [53], "hunks": [{"title": "@@ -50,4 +50,4 @@ def cat_file (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"50\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"51\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"52\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"53\"><span class=\"d-s\">- </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"53\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "52da543484f7377fdb96ac916e9e42de2fd10dcd", "ugit/cli.py": "beee26c8e13bd8c6fc65e8440c8edf2c1ebdb581", "ugit/data.py": "6e7bccef42fd7350e4c4c8f1f9ddced4f2b32ef6"}}, {"oid": "63bc9f2cd45eee1719242223dcc0f79aa0900641", "id": "read-tree", "title": "read-tree: Extract tree from object", "message": "<p>This command will take an OID of a tree and extract it to the working directory. Kind of the opposite of <code>write-tree</code>.</p>\n<p>I divided the implementation into a few layers:</p>\n<p><code>_iter_tree_entries</code> is a generator that will take an OID of a tree, tokenize it line-by-line and yield the raw string values.</p>\n<p><code>get_tree</code> uses <code>_iter_tree_entries</code> to recursively parse a tree into a dictionary.</p>\n<p><code>read_tree</code> uses get_tree to get the file OIDs and writes them into the working directory.</p>\n<p>Now we can actually save versions of the working directory! It's nothing like proper version control, but we can see that a super basic flow is possible:</p>\n<ol type=\"1\">\n<li>Imagine you work on some code and you want to save a version.</li>\n<li>You run <code>ugit write-tree</code>.</li>\n<li>You remember that OID that was printed out (write it on a post-it note or something :)).</li>\n<li>Continue working and repeat steps 2 and 3 as necessary.</li>\n<li>If you want to return to a previous version, use <code>ugit read-tree</code> to restore it to the working directory.</li>\n</ol>\n<p>Is it convenient to use? No. But it's just the beginning!</p>\n", "diff": {"ugit/base.py": {"changed_lines": [29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59], "hunks": [{"title": "@@ -26,5 +26,36 @@ def write_tree (directory='.'):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"26\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"28\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"29\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"30\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"31\"><span class=\"d-s\">+ </span>        <span class=\"k\">return</span>\n</span><span class=\"line d-a\" data-line=\"32\"><span class=\"d-s\">+ </span>    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"33\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"34\"><span class=\"d-s\">+ </span>        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"35\"><span class=\"d-s\">+ </span>        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line d-a\" data-line=\"36\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"37\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"38\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"39\"><span class=\"d-s\">+ </span>    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line d-a\" data-line=\"40\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"41\"><span class=\"d-s\">+ </span>        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line d-a\" data-line=\"42\"><span class=\"d-s\">+ </span>        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"43\"><span class=\"d-s\">+ </span>        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line d-a\" data-line=\"44\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"45\"><span class=\"d-s\">+ </span>            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"46\"><span class=\"d-s\">+ </span>        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"47\"><span class=\"d-s\">+ </span>            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"48\"><span class=\"d-s\">+ </span>        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"49\"><span class=\"d-s\">+ </span>            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"50\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line d-a\" data-line=\"51\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"52\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"53\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"54\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"55\"><span class=\"d-s\">+ </span>        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"56\"><span class=\"d-s\">+ </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"57\"><span class=\"d-s\">+ </span>            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"58\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"59\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"60\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [34, 35, 36, 37, 58, 59, 60, 61], "hunks": [{"title": "@@ -31,6 +31,10 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"31\"><span class=\"d-s\">  </span>    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\"><span class=\"d-s\">  </span>    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"34\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"35\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"36\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"37\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"38\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"39\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -51,3 +55,7 @@ def cat_file (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"55\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line d-a\" data-line=\"58\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"59\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"60\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"61\"><span class=\"d-s\">+ </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "5569eafd4756113650245b06fd70f627e7b44bd0", "ugit/cli.py": "76308491f6558a900e7a420cdfba353cd3b58f52", "ugit/data.py": "6e7bccef42fd7350e4c4c8f1f9ddced4f2b32ef6"}}, {"oid": "4a5b0f2b0153dafd85c90c39ada121558b27cbd4", "id": "read-tree-cleanup", "title": "read-tree: Delete all existing stuff before reading", "message": "<p>This is done so that we won't have any old files left around after a read-tree.</p>\n<p>Before this change, if we save tree A which contains only <em>a.txt</em>, then we save tree B which contains <em>a.txt</em> and <em>b.txt</em> and then we <code>read-tree</code> A, we will have <em>b.txt</em> left over in the working directory.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 73], "hunks": [{"title": "@@ -50,7 +50,27 @@ def get_tree (oid, base_path=''):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"50\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"51\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"52\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"53\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"54\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"55\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"56\"><span class=\"d-s\">+ </span>            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"57\"><span class=\"d-s\">+ </span>            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"58\"><span class=\"d-s\">+ </span>                <span class=\"k\">continue</span>\n</span><span class=\"line d-a\" data-line=\"59\"><span class=\"d-s\">+ </span>            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"60\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"61\"><span class=\"d-s\">+ </span>            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"62\"><span class=\"d-s\">+ </span>            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"63\"><span class=\"d-s\">+ </span>                <span class=\"k\">continue</span>\n</span><span class=\"line d-a\" data-line=\"64\"><span class=\"d-s\">+ </span>            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"65\"><span class=\"d-s\">+ </span>                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"66\"><span class=\"d-s\">+ </span>            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"67\"><span class=\"d-s\">+ </span>                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line d-a\" data-line=\"68\"><span class=\"d-s\">+ </span>                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line d-a\" data-line=\"69\"><span class=\"d-s\">+ </span>                <span class=\"k\">pass</span>\n</span><span class=\"line d-a\" data-line=\"70\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"71\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"72\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"73\"><span class=\"d-s\">+ </span>    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\"><span class=\"d-s\">  </span>        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\"><span class=\"d-s\">  </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "35c295e16d313fb6e799d3f2d349bf963aedfe89", "ugit/cli.py": "76308491f6558a900e7a420cdfba353cd3b58f52", "ugit/data.py": "6e7bccef42fd7350e4c4c8f1f9ddced4f2b32ef6"}}, {"oid": "779eecd201ad4cf6a8a3034580579be4b4d29feb", "id": "create-commit", "title": "commit: Create commit", "message": "<p>So far we were able to save versions of a directory (with <code>write-tree</code>), but without any additional context. In reality, when we save a snapshot we would like to attach data such as:</p>\n<ul>\n<li>Message describing it</li>\n<li>When the snapshot was created</li>\n<li>Who created the snapshot</li>\n<li>...</li>\n</ul>\n<p>We will create a new type of object called a \"commit\" that will store all this information. A commit will just be a text file stored in the object database with the type of <code>'commit'</code>.</p>\n<p>The first lines in the commit will be key-values, then an empty line will mark the end of the key-values and then the commit message will follow. Like this:</p>\n<pre><code>tree 5e550586c91fce59e0006799e0d46b3948f05693\nauthor Nikita Leshenko\ntime 2019-09-14T09:31:09+00:00\n\nThis is the commit message!</code></pre>\n<p>For now we'll just write the \"tree\" key and the commit message to the commit object.</p>\n<p>We will create a new <code>ugit commit</code> command that will accept a commit message, snapshot the current directory using <code>ugit write-tree</code> and save the resulting object.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [80, 81, 82, 83, 84, 85, 86, 87], "hunks": [{"title": "@@ -77,5 +77,13 @@ def read_tree (tree_oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"77\"><span class=\"d-s\">  </span>            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"78\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"79\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"80\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"81\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"82\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"83\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"84\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"85\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"86\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"87\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"88\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"89\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [38, 39, 40, 41, 66, 67, 68, 69], "hunks": [{"title": "@@ -35,6 +35,10 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"35\"><span class=\"d-s\">  </span>    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\"><span class=\"d-s\">  </span>    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"38\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"39\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"40\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"41\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"42\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"43\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -59,3 +63,7 @@ def write_tree (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"63\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"64\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\"><span class=\"d-s\">  </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"66\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"67\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"68\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"69\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "08579adeda3e356d3572db10b6caa4ec61c9e0e1", "ugit/cli.py": "239a040d8feb19c5e6ef010a9018044b54f9fe19", "ugit/data.py": "6e7bccef42fd7350e4c4c8f1f9ddced4f2b32ef6"}}, {"oid": "544d44535a9d036b590cb5354e3469f6ecd65f51", "id": "commit-update-head", "title": "commit: Record hash of last commit to HEAD", "message": "<p>I would like to link new commits to older commits. Right now, if we make changes in the working directory and make periodic commits, each commit will be a standalone object, separate from all other commits. The motivation for linking them together is so that we can look at the commits as a series of shapshots in some order.</p>\n<p>Before we can do it, let's record the OID of the last commit that we created. We'll call the last commit the <strong>\"HEAD\"</strong> and just put the OID in <em>.ugit/HEAD</em> file.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [85, 86, 87, 88, 89], "hunks": [{"title": "@@ -82,7 +82,11 @@ def commit (message):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"82\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"85\"><span class=\"d-s\">- </span>    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"85\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"86\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"87\"><span class=\"d-s\">+ </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"88\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"89\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"91\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"92\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [13, 14, 15, 16, 17], "hunks": [{"title": "@@ -10,6 +10,11 @@ def init ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"10\"><span class=\"d-s\">  </span>    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"12\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"13\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"14\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"15\"><span class=\"d-s\">+ </span>        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"16\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"17\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"18\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\"><span class=\"d-s\">  </span>    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"20\"><span class=\"d-s\">  </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "d27558374110c82774b9a1745ec787c3d71b8d61", "ugit/cli.py": "239a040d8feb19c5e6ef010a9018044b54f9fe19", "ugit/data.py": "fb5ced827fc783b4c78bcba96e13259cca45a40d"}}, {"oid": "30351f78eb1bebe00bdf1517c083261c48bb906a", "id": "commit-write-parent", "title": "commit: set parent to HEAD", "message": "<p>When creating a new commit, we will use the HEAD to link the new commit to the previous commit. We'll call the previous commit the \"parent commit\" and we will save its OID in the \"parent\" key on the commit object.</p>\n<p>For example, HEAD is currently bd0de093f1a0f90f54913d694a11cccf450bd990 and we create a new commit, the new commit will look like this in the object store:</p>\n<pre><code>tree 50bed982245cd21e2798f179e0b032904398485b\nparent bd0de093f1a0f90f54913d694a11cccf450bd990\n\nThis is the commit message!</code></pre>\n<p>The first commit in the repository will obviously have no parent.</p>\n<p>Now we can retrieve the entire list of commits just by referencing the last commit! We can start from the HEAD, read the \"parent\" key on the HEAD commit and discover the commit before HEAD. Then read the parent of that commit, and go back on and on... This is basically a linked list implemented over the object database.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [82, 83, 84, 85, 86], "hunks": [{"title": "@@ -79,6 +79,11 @@ def read_tree (tree_oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"79\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"80\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"82\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"83\"><span class=\"d-s\">+ </span>    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"84\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"85\"><span class=\"d-s\">+ </span>        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"86\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"87\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"88\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [18, 19, 20, 21, 22, 23], "hunks": [{"title": "@@ -15,6 +15,12 @@ def set_HEAD (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"15\"><span class=\"d-s\">  </span>        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"17\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"18\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_HEAD</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"19\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"20\"><span class=\"d-s\">+ </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"21\"><span class=\"d-s\">+ </span>            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"22\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"23\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"24\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"25\"><span class=\"d-s\">  </span>    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"26\"><span class=\"d-s\">  </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "77c0f89ae1d745af6d339142509da572cbe55b0a", "ugit/cli.py": "239a040d8feb19c5e6ef010a9018044b54f9fe19", "ugit/data.py": "8062609ba86003ca154f7cb9a9a461f54d13b409"}}, {"oid": "1f238264303e950dbbe3d9027f96b97ee0110e96", "id": "log", "title": "log: Implement", "message": "<p><code>log</code> will walk the list of commits and print them.</p>\n<p>We will start by implementing <code>get_commit()</code> that will parse a commit object by OID.</p>\n<p>Then in the CLI module we will start from the HEAD commit and walk its parents until we reach a commit without a parent.</p>\n<p>The result is that the entire commit history is printed to the screen once we run <code>ugit log</code>.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [1, 2, 5, 6, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121], "hunks": [{"title": "@@ -1,5 +1,9 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line d-a\" data-line=\"1\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line d-a\" data-line=\"2\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"5\"><span class=\"d-s\">+ </span><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line d-a\" data-line=\"6\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -94,5 +98,26 @@ def commit (message):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"101\"><span class=\"d-s\">+ </span><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line d-a\" data-line=\"102\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"104\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"105\"><span class=\"d-s\">+ </span>    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line d-a\" data-line=\"106\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"107\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"108\"><span class=\"d-s\">+ </span>    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line d-a\" data-line=\"109\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"110\"><span class=\"d-s\">+ </span>        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"111\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"112\"><span class=\"d-s\">+ </span>            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line d-a\" data-line=\"113\"><span class=\"d-s\">+ </span>        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"114\"><span class=\"d-s\">+ </span>            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line d-a\" data-line=\"115\"><span class=\"d-s\">+ </span>        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"116\"><span class=\"d-s\">+ </span>            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"117\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"118\"><span class=\"d-s\">+ </span>    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"119\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"120\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"121\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"122\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"123\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [4, 43, 44, 45, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85], "hunks": [{"title": "@@ -1,6 +1,7 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line d-a\" data-line=\"4\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span></code></pre></div>\n"}, {"title": "@@ -39,6 +40,9 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"40\"><span class=\"d-s\">  </span>    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\"><span class=\"d-s\">  </span>    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"43\"><span class=\"d-s\">+ </span>    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"44\"><span class=\"d-s\">+ </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"45\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"46\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"47\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -67,3 +71,15 @@ def read_tree (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"71\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"72\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"74\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"75\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"76\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"77\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"78\"><span class=\"d-s\">+ </span>    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"79\"><span class=\"d-s\">+ </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"80\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"81\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"82\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"83\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"84\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"85\"><span class=\"d-s\">+ </span>        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "3ecd623cd73999918887e2a65b9e24dfd77c2171", "ugit/cli.py": "b85f77308cb3a0c9f27da6070997ac945278d3d7", "ugit/data.py": "8062609ba86003ca154f7cb9a9a461f54d13b409"}}, {"oid": "984b0cf63d058ce13051b33bcac2fd8376ba62ed", "id": "log-start-from-oid", "title": "log: Add oid parameter", "message": "<p>Just a small cosmetic change: Instead of always printing the list of commits from HEAD, add an optional parameter to specify an alternative commit OID to start from. By default it will still be HEAD.</p>\n", "diff": {"ugit/cli.py": {"changed_lines": [45, 78], "hunks": [{"title": "@@ -42,6 +42,7 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"42\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"43\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"45\"><span class=\"d-s\">+ </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"47\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}, {"title": "@@ -74,7 +75,7 @@ def commit (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"75\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"76\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"77\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"78\"><span class=\"d-s\">- </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"78\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"79\"><span class=\"d-s\">  </span>    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "3ecd623cd73999918887e2a65b9e24dfd77c2171", "ugit/cli.py": "342b1291413f941b50dc47f9a4195d5da30ba9b1", "ugit/data.py": "8062609ba86003ca154f7cb9a9a461f54d13b409"}}, {"oid": "a9519b5818a24c03517bf8ad1265aa634dcadb26", "id": "checkout-read-tree", "title": "checkout: Read tree and move HEAD", "message": "<p>When given a commit OID, <code>ugit checkout</code> will \"checkout\" that commit, meaning that it will populate the working directory with the content of the commit and move HEAD to point to it.</p>\n<p>This is a small but important change and it greatly expands the power of ugit in two ways.</p>\n<p>First, it allows us to travel conveniently in history. If we've made a handful of commits and we would like to revisit a previous commit, we can now \"checkout\" that commit to the working directory, play with it (compile, run tests, read code, whatever we want) and checkout the latest commit again to resume working where we've left.</p>\n<p>You might be wondering why <code>checkout</code> is needed when we could just use <code>read-tree</code>, and the answer is that moving HEAD in addition to reading the tree allows us to record which commit is checked out right now. If we would only use <code>read-tree</code> and later forget which commit we are looking at, we will see a bunch of files in the working directory and have no idea where they came from. On the other hand, if we use <code>checkout</code>, the commit will be recorded in HEAD and we can always know what we're looking at (by running <code>ugit log</code> for example and seeing the first entry).</p>\n<p>The second way by which <code>checkout</code> expands the power of ugit is by allowing multiple branches of history. Let me explain: So far we have set HEAD to point to the latest commit that was created. It means that all our commits were linear, each new commit was added on top of the previous. The <code>checkout</code> command now allows us to move HEAD to any commit we wish. Then, new commits will be created on top of the current HEAD commit, which isn't nesessarily the last created commit.</p>\n<p>For example, imagine that we're working on some code. So far, we have created a few commits, represented by a graph:</p>\n<pre><code>o-----o-----o-----o\n^                 ^\nfirst commit      HEAD</code></pre>\n<p>Then we wanted to code a new feature. We created a few commits while working on the feature (new commits represented by @):</p>\n<pre><code>o-----o-----o-----o-----@-----@-----@\n^                                   ^\nfirst commit                        HEAD</code></pre>\n<p>Now we have an alternative idea for implementing that feature. We would like to go back in time and try a different implementation, without throwing away the current implementation. We can remember the current HEAD and run <code>ugit checkout</code> to go back in time, by providing the OID of the commit before the new feature was implemented (that OID can be discovered with <code>ugit log</code>).</p>\n<pre><code>o-----o-----o-----o-----@-----@-----@\n^                 ^\nfirst commit      HEAD</code></pre>\n<p>The working directory will effectively go back in time. We can start working on an alternative implementation and create new commit. The new commits will be on top of HEAD and look like this (represented by $):</p>\n<pre><code>o-----o-----o-----o-----@-----@-----@\n^                  \\\nfirst commit        ----$-----$\n                              ^\n                              HEAD</code></pre>\n<p>See how the history is now contains two \"branches\". We can actually switch back and forth between them and work on them in parallel. Finally, we can checkout the preferred implementation and work from it on future code. Assuming that we liked the second branch, we'll just keep working from it, and future commits will look like this:</p>\n<pre><code>o-----o-----o-----o-----@-----@-----@\n^                  \\\nfirst commit        ----$-----$-----o-----o-----o-----o-----o\n                                                            ^\n                                                            HEAD</code></pre>\n<p>Pretty useful, right? We've just introduced a simple form of branching history. Note that something pretty cool happened here: The implementation of checkout is very simple (we just call <code>read_tree</code> and update HEAD) but the implications of checkout are quite big - we can suddenly have a branching workflow which might look complicated but it is actually a direct consequence of what we implemented in previous changes. This is why I believe learning Git internals from the bottom up is useful - we can see how simple concepts compose into complicated functionality.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [101, 102, 103, 104, 105, 106], "hunks": [{"title": "@@ -98,6 +98,12 @@ def commit (message):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"101\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"102\"><span class=\"d-s\">+ </span>    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"104\"><span class=\"d-s\">+ </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"105\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"106\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"107\"><span class=\"d-s\">  </span><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"108\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [47, 48, 49, 50, 91, 92, 93, 94], "hunks": [{"title": "@@ -44,6 +44,10 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"44\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"47\"><span class=\"d-s\">+ </span>    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"48\"><span class=\"d-s\">+ </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"49\"><span class=\"d-s\">+ </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"50\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"51\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"52\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -84,3 +88,7 @@ def log (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"88\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"90\"><span class=\"d-s\">  </span>        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line d-a\" data-line=\"91\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"92\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"93\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"94\"><span class=\"d-s\">+ </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "ecb98451d8dbd7878135db27e52609665f772236", "ugit/cli.py": "57043fab7a72af3dc5b1e8ad875f340d95488aa5", "ugit/data.py": "8062609ba86003ca154f7cb9a9a461f54d13b409"}}, {"oid": "ad7b545d89c5593a1427e3a524038fc32de1bf19", "id": "tag-cli-command", "title": "tag: Implement CLI command", "message": "<p>Now that we have branching history we have some OIDs we need to keep track of. Assume we have two branches (continuing from the example we had for <code>checkout</code>):</p>\n<pre><code>o-----o-----o-----o-----@-----@-----@\n^                  \\                ^\nfirst commit        ----$-----$     6c9f80a187ba39b4...\n                              ^\n                              d8d43b0e3a21df0c...</code></pre>\n<p>If we want to switch back and forth between the two \"branches\" with <code>checkout</code>, we need to remember both OIDs, which are quite long.</p>\n<p>To make our lives easier, let's implement a command to attach a name to an OID. Then we'll be able to refer to the OID by that name.</p>\n<p>The end result will look like this:</p>\n<pre><code>$ # Make some changes\n...\n$ ugit commit\nd8d43b0e3a21df0c845e185d08be8e4028787069\n$ ugit tag my-cool-commit d8d43b0e3a21df0c845e185d08be8e4028787069\n$ # Make more changes\n...\n$ ugit commit\ne549f09bbd08a8a888110b07982952e17e8c9669\n\n$ ugit checkout my-cool-commit\n        or\n$ ugit checkout d8d43b0e3a21df0c845e185d08be8e4028787069</code></pre>\n<p>The last two commands are equivalent, because <em>my-cool-commit</em> is a tag that points to d8d43b0e3a21df0c845e185d08be8e4028787069.</p>\n<p>We will implement this in a few steps. The first step is to create a CLI commmand that call the relevant command in the <em>base</em> module. The <em>base</em> module does nothing at this stage.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [107, 108, 109, 110, 111], "hunks": [{"title": "@@ -104,6 +104,11 @@ def checkout (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"104\"><span class=\"d-s\">  </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"106\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"107\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"108\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># TODO Actually create the tag</span>\n</span><span class=\"line d-a\" data-line=\"109\"><span class=\"d-s\">+ </span>    <span class=\"k\">pass</span>\n</span><span class=\"line d-a\" data-line=\"110\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"111\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"112\"><span class=\"d-s\">  </span><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"113\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [51, 52, 53, 54, 55, 100, 101, 102, 103, 104], "hunks": [{"title": "@@ -48,6 +48,11 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"48\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"51\"><span class=\"d-s\">+ </span>    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"52\"><span class=\"d-s\">+ </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"53\"><span class=\"d-s\">+ </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"54\"><span class=\"d-s\">+ </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"55\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -92,3 +97,8 @@ def log (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"97\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"100\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"101\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"102\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"104\"><span class=\"d-s\">+ </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "62e96faaf8a3f15ca46477cc1a5e9c3e2fbdcc2d", "ugit/cli.py": "332414e4f93fcee70eb0d3eb604f55cc7546261f", "ugit/data.py": "8062609ba86003ca154f7cb9a9a461f54d13b409"}}], "objects": {"52da543484f7377fdb96ac916e9e42de2fd10dcd": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"7\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"8\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"9\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"10\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"11\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"25\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "beee26c8e13bd8c6fc65e8440c8edf2c1ebdb581": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"45\">\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span></code></pre></div>\n", "5569eafd4756113650245b06fd70f627e7b44bd0": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"7\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"8\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"9\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"10\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"11\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"25\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"45\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"47\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"57\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "76308491f6558a900e7a420cdfba353cd3b58f52": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">\n</span><span class=\"line\" data-line=\"46\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"54\">\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "35c295e16d313fb6e799d3f2d349bf963aedfe89": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"7\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"8\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"9\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"10\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"11\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"25\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"45\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"47\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"58\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"59\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"68\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"69\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"77\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "08579adeda3e356d3572db10b6caa4ec61c9e0e1": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"7\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"8\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"9\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"10\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"11\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"25\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"45\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"47\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"58\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"59\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"68\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"69\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"77\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">\n</span><span class=\"line\" data-line=\"88\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "239a040d8feb19c5e6ef010a9018044b54f9fe19": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"53\">\n</span><span class=\"line\" data-line=\"54\">\n</span><span class=\"line\" data-line=\"55\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span></code></pre></div>\n", "d27558374110c82774b9a1745ec787c3d71b8d61": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"7\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"8\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"9\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"10\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"11\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"25\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"45\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"47\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"58\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"59\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"68\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"69\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"77\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "fb5ced827fc783b4c78bcba96e13259cca45a40d": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"9\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">partition</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span></code></pre></div>\n", "77c0f89ae1d745af6d339142509da572cbe55b0a": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"7\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"8\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"9\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"10\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"11\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"25\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"45\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"47\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"58\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"59\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"68\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"69\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"77\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"85\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"98\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "8062609ba86003ca154f7cb9a9a461f54d13b409": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"9\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\"><span class=\"k\">def</span> <span class=\"nf\">get_HEAD</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">partition</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span></code></pre></div>\n", "3ecd623cd73999918887e2a65b9e24dfd77c2171": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"13\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"51\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"53\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"63\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"69\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"71\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"73\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"81\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"112\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"113\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"114\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"115\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "b85f77308cb3a0c9f27da6070997ac945278d3d7": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">\n</span><span class=\"line\" data-line=\"46\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">\n</span><span class=\"line\" data-line=\"54\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span></code></pre></div>\n", "342b1291413f941b50dc47f9a4195d5da30ba9b1": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"52\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">\n</span><span class=\"line\" data-line=\"54\">\n</span><span class=\"line\" data-line=\"55\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"84\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span></code></pre></div>\n", "ecb98451d8dbd7878135db27e52609665f772236": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"13\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"51\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"53\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"63\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"69\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"71\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"73\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"81\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"112\">\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"114\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"115\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"118\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"119\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"122\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"123\">\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"129\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "57043fab7a72af3dc5b1e8ad875f340d95488aa5": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">\n</span><span class=\"line\" data-line=\"54\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"88\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\">\n</span><span class=\"line\" data-line=\"93\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "62e96faaf8a3f15ca46477cc1a5e9c3e2fbdcc2d": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"13\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"51\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"53\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"63\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"69\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"71\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"73\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"81\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"c1\"># TODO Actually create the tag</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"123\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"124\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"125\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"126\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"127\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"130\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "332414e4f93fcee70eb0d3eb604f55cc7546261f": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}}