{"commits": [{"oid": "99887be04e0474838b0dd6fd0b1c026ebb520382", "id": "merge-record-both-parents", "title": "merge: Record both parents on commit", "message": "<p>Earlier we merged two commits in the working directory, now we will make sure that a merge commit is created once we commit the merged working directory.</p>\n<p><code>ugit merge</code> command will store the branch we want to merge with in a new ref called <em>MERGE_HEAD</em>. So in our previous example:</p>\n<pre><code>                HEAD\n                v\no---o---o---o---o\n     \\\n      --o---o\n            ^\n            some-branch</code></pre>\n<p>After running <code>ugit merge some-branch</code>, <em>MERGE_HEAD</em> will be created and point to <em>some-branch</em>. The presence of <em>MERGE_HEAD</em> tells ugit that on the next commit is a merge commit with two parents - HEAD and <em>MERGE_HEAD</em>:</p>\n<pre><code>                HEAD\n                v\no---o---o---o---o\n     \\\n      --o---o &lt; MERGE_HEAD\n            ^\n            some-branch</code></pre>\n<p>So upon <code>ugit commit</code>, ugit will create a commit which will look like we want:</p>\n<pre><code>o---o---o---o---o\n     \\           \\\n      --o---o-----o &lt; HEAD\n            ^\n            some-branch</code></pre>\n<p><em>MERGE_HEAD</em> can be deleted at this point.</p>\n<p>You can see that we changed <code>base.merge</code> to set <em>MERGE_HEAD</em>, <code>base.commit</code> to take <em>MERGE_HEAD</em> into account and <code>cli.status</code> to helpfully inform the user when we're in the middle of a merge.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [117, 118, 119, 120, 155, 156, 158], "hunks": [{"title": "@@ -114,6 +114,10 @@ def commit (message):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"114\"><span class=\"d-s\">  </span>    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"115\"><span class=\"d-s\">  </span>    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"117\"><span class=\"d-s\">+ </span>    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line d-a\" data-line=\"118\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"119\"><span class=\"d-s\">+ </span>        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"120\"><span class=\"d-s\">+ </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"122\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"123\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span></code></pre></div>\n"}, {"title": "@@ -148,8 +152,10 @@ def merge (other):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"152\"><span class=\"d-s\">  </span>    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"153\"><span class=\"d-s\">  </span>    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"155\"><span class=\"d-s\">+ </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"156\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"157\"><span class=\"d-s\">  </span>    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"158\"><span class=\"d-s\">- </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"158\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"160\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"161\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [209, 210, 211, 212], "hunks": [{"title": "@@ -206,6 +206,10 @@ def status (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"206\"><span class=\"d-s\">  </span>    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"207\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"209\"><span class=\"d-s\">+ </span>    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line d-a\" data-line=\"210\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"211\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"212\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"213\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"214\"><span class=\"d-s\">  </span>    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"215\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "f76da3e52397760e5a4bea91cd8c311726ec7afe", "ugit/cli.py": "c95f0aeb82b2b127c42a1f1b5cf356f145641f47", "ugit/data.py": "9224a612af2fadd5414a530a02852e457af3ad61", "ugit/diff.py": "e740248bc87e18bd244ca219330df3c4e7ac19cf"}}, {"oid": "a18eecc01f21224e75529c33cd5ce3dc6e4d8776", "id": "iterate-merge-head", "title": "data: Iter over MERGE_HEAD if it exists", "message": "<p>Since we've added <em>MERGE_HEAD</em> in the last change, it would be useful to visualize it as well when running <code>ugit k</code>. Add it to the list of refs to iterate over.</p>\n<p>Since <em>MERGE_HEAD</em> may not exist (we might not be in the middle of a merge), add a check to <code>iter_refs</code> to avoid returning non-existing refs.</p>\n", "diff": {"ugit/data.py": {"changed_lines": [58, 66, 67, 68], "hunks": [{"title": "@@ -55,7 +55,7 @@ def _get_ref_internal (ref, deref):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"55\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"58\"><span class=\"d-s\">- </span>    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line d-a\" data-line=\"58\"><span class=\"d-s\">+ </span>    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"59\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\"><span class=\"d-s\">  </span>        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\"><span class=\"d-s\">  </span>        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -63,7 +63,9 @@ def iter_refs (prefix='', deref=True):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"63\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"64\"><span class=\"d-s\">  </span>        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">refname</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\"><span class=\"d-s\">  </span>            <span class=\"k\">continue</span>\n</span><span class=\"line d-r\" data-line=\"66\"><span class=\"d-s\">- </span>        <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"n\">deref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"66\"><span class=\"d-s\">+ </span>        <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"n\">deref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"67\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"68\"><span class=\"d-s\">+ </span>            <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span>\n</span><span class=\"line\" data-line=\"69\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"70\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"71\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "f76da3e52397760e5a4bea91cd8c311726ec7afe", "ugit/cli.py": "c95f0aeb82b2b127c42a1f1b5cf356f145641f47", "ugit/data.py": "27b64966e1b06b2bf04a38dead7ca04779f21d32", "ugit/diff.py": "e740248bc87e18bd244ca219330df3c4e7ac19cf"}}, {"oid": "6cafda8de0b9f0da7699fc5ad0454c7bd403ca88", "id": "compute-common-ancestor", "title": "merge-base: Compute common ancestor of a commit", "message": "<p>This command is called <code>merge-base</code>, it will receive two commit OIDs and find their common ancestor. In other words, it will find the first parent commit that both of them share. Graphically it looks like this:</p>\n<pre><code>    commit C    commit A\n    v           v\no---o---o---o---o\n     \\\n      --o---o\n            ^\n            commit B</code></pre>\n<p>Commit C is the first commmn ancestor of commits A and B.</p>\n<p>This command isn't very useful by itself, but we will explain the motivation for it in the following change. The name <code>merge-base</code> might hint that it will we be related to improving our <code>merge</code> command.</p>\n<p>Its operation is pretty brute-force: It saves all parents of the first commit to a list and it iterates over the parents of the second commit in ancestry order until it reaches a parent that is a parent of the first commit.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [161, 162, 163, 164, 165, 166, 167, 168], "hunks": [{"title": "@@ -158,6 +158,14 @@ def merge (other):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"158\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"160\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"161\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"162\"><span class=\"d-s\">+ </span>    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">list</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line d-a\" data-line=\"163\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"164\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line d-a\" data-line=\"165\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"166\"><span class=\"d-s\">+ </span>            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"167\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"168\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"169\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"170\"><span class=\"d-s\">  </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [87, 88, 89, 90, 91, 231, 232, 233, 234], "hunks": [{"title": "@@ -84,6 +84,11 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"84\"><span class=\"d-s\">  </span>    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\"><span class=\"d-s\">  </span>    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"87\"><span class=\"d-s\">+ </span>    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"88\"><span class=\"d-s\">+ </span>    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"89\"><span class=\"d-s\">+ </span>    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"90\"><span class=\"d-s\">+ </span>    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"91\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"92\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"93\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -223,3 +228,7 @@ def reset (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"228\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"229\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"230\"><span class=\"d-s\">  </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"231\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"232\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"233\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"234\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "ca2cbac108846b70d0ac9a391ed22678192d2afc", "ugit/cli.py": "9b0346f321f26f08647e00da3852dc6db04bee97", "ugit/data.py": "27b64966e1b06b2bf04a38dead7ca04779f21d32", "ugit/diff.py": "e740248bc87e18bd244ca219330df3c4e7ac19cf"}}, {"oid": "35cb26c0a430d738191d63a9a19a4be450b3b222", "id": "merge-three-way", "title": "merge: Three-way merge", "message": "<p>Next, let's improve the quality of our merges by using a technique called <strong>three-way merge</strong>. Before we talk about three-way merge, let's talk about two-way merge, which is the technique we've used so far.</p>\n<p>Two-way merge means that we look at two versions of the same file and we try to merge them into one. Sometimes it works well. For example, if we have:</p>\n<ul>\n<li><p>Version A:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Meow&quot;)\n    while True:\n          print (&quot;Purr&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Bark!&quot;)\n    return False</code></pre></li>\n<li><p>Version B:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Meow&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Bark!&quot;)\n    print (&quot;Wiggle tail&quot;)\n    return False</code></pre></li>\n</ul>\n<p>It's pretty easy to merge them together, because it's clear from the context which are the common parts and which parts were added in each version.</p>\n<ul>\n<li><p>A and B merged:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Meow&quot;)\n    while True:\n          print (&quot;Purr&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Bark!&quot;)\n    print (&quot;Wiggle tail&quot;)\n    return False</code></pre></li>\n</ul>\n<p>And that's exactly what our <code>diff</code> CLI command would do. But let's see an example where two-way merge doesn't work well:</p>\n<ul>\n<li><p>Version A:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Sleep&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Bark!&quot;)\n    return False</code></pre></li>\n<li><p>Version B:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Meow&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Eat homework&quot;)\n    return False</code></pre></li>\n</ul>\n<p>How should we merge them? We have a conflict in each print statement. It means that the best we can do is leave both changes and let the user decide:</p>\n<ul>\n<li><p>A and B merged:</p>\n<pre><code>def be_a_cat ():\n&lt;&lt;&lt;&lt;&lt;&lt;&lt; Version A\n    print (&quot;Sleep&quot;)\n=======\n    print (&quot;Meow&quot;)\n&gt;&gt;&gt;&gt;&gt;&gt;&gt; Version B\n    return True\n\ndef be_a_dog ():\n&lt;&lt;&lt;&lt;&lt;&lt;&lt; Version A\n    print (&quot;Bark!&quot;)\n=======\n    print (&quot;Eat homework&quot;)\n&gt;&gt;&gt;&gt;&gt;&gt;&gt; Version B\n    return False</code></pre></li>\n</ul>\n<p>Now assume that version A and version B are the same file but from different branches. For example like this:</p>\n<pre><code>                version A\n                v\no---o---o---o---o\n     \\\n      --o---o\n            ^\n            version B</code></pre>\n<p>There's one more interesting piece of information that we didn't use during the two-way merge: The file might be present in their common ancestor and it might give us useful context about the merge. For example, assuming we know this:</p>\n<ul>\n<li><p>Version A:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Sleep&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Bark!&quot;)\n    return False</code></pre></li>\n<li><p>Version B:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Meow&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Eat homework&quot;)\n    return False</code></pre></li>\n<li><p>Common ancestor:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Meow&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Bark!&quot;)\n    return False</code></pre></li>\n</ul>\n<p>We can actually understand that version A changed only <code>be_a_cat</code>'s print statement while version B changed only <code>be_a_dog</code>'s print statement. It means that each version changed unrelated pieces of the code and we can merge the safely into:</p>\n<ul>\n<li><p>A and B merged using common ancestor:</p>\n<pre><code>def be_a_cat ():\n    print (&quot;Sleep&quot;)\n    return True\n\ndef be_a_dog ():\n    print (&quot;Eat homework&quot;)\n    return False</code></pre></li>\n</ul>\n<p>This is called a <strong>three-way merge</strong> - an algorithm that merges two files using their common ancestor as a guide. It improves merge quality dramatically (meaning less conflics on each merge). If you'd like to know more, please search online :).</p>\n<p>We would like to use three-way merges in ugit. For that we're going to use <code>get_merge_base</code> that we've implemented earlier and modify <code>diff.merge_trees</code> to accept a common ancestor (called a \"base\").</p>\n<p>We don't need a lot of logic changes to make it happen. Our <code>compare_trees</code> function can compare an arbitrary number of trees, so we just add the base tree there as well. Then <code>merge_blobs</code> will call <code>diff3</code> CLI command which performs three-way merges.</p>\n<p>You can try playing with the resulting code to see that the merge results are way way better.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [103, 105, 106, 153, 154, 160], "hunks": [{"title": "@@ -100,9 +100,10 @@ def read_tree (tree_oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"102\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"103\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\"><span class=\"d-s\">  </span>    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line d-r\" data-line=\"105\"><span class=\"d-s\">- </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"105\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line d-a\" data-line=\"106\"><span class=\"d-s\">+ </span>            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"107\"><span class=\"d-s\">  </span>        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\"><span class=\"d-s\">  </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"109\"><span class=\"d-s\">  </span>            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -149,12 +150,14 @@ def reset (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"150\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\"><span class=\"d-s\">  </span>    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\"><span class=\"d-s\">  </span>    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line d-a\" data-line=\"153\"><span class=\"d-s\">+ </span>    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"154\"><span class=\"d-s\">+ </span>    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\"><span class=\"d-s\">  </span>    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"156\"><span class=\"d-s\">  </span>    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"157\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"158\"><span class=\"d-s\">  </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"159\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"160\"><span class=\"d-s\">- </span>    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"160\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"161\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"162\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}, "ugit/diff.py": {"changed_lines": [53, 55, 56, 60, 61, 62, 63, 64, 70, 71, 72, 73, 76], "hunks": [{"title": "@@ -50,25 +50,29 @@ def diff_blobs (o_from, o_to, path='blob'):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"50\"><span class=\"d-s\">  </span>        <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span><span class=\"line\" data-line=\"51\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"52\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"53\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"53\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"54\"><span class=\"d-s\">  </span>    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line d-r\" data-line=\"55\"><span class=\"d-s\">- </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"55\"><span class=\"d-s\">- </span>        <span class=\"n\">tree</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"55\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"56\"><span class=\"d-s\">+ </span>        <span class=\"n\">tree</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"58\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"59\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"60\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"60\"><span class=\"d-s\">- </span>    <span class=\"k\">with</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_HEAD</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_other</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"60\"><span class=\"d-s\">- </span>        <span class=\"k\">for</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"p\">((</span><span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_other</span><span class=\"p\">,</span> <span class=\"n\">f_other</span><span class=\"p\">)):</span>\n</span><span class=\"line d-a\" data-line=\"60\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"61\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_base</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_HEAD</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_other</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"62\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"63\"><span class=\"d-s\">+ </span>        <span class=\"c1\"># Write blobs to files</span>\n</span><span class=\"line d-a\" data-line=\"64\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"p\">((</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">f_base</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_other</span><span class=\"p\">,</span> <span class=\"n\">f_other</span><span class=\"p\">)):</span>\n</span><span class=\"line\" data-line=\"65\"><span class=\"d-s\">  </span>            <span class=\"k\">if</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\"><span class=\"d-s\">  </span>                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"67\"><span class=\"d-s\">  </span>                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"68\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"69\"><span class=\"d-s\">  </span>        <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line d-r\" data-line=\"70\"><span class=\"d-s\">- </span>            <span class=\"p\">[</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-r\" data-line=\"70\"><span class=\"d-s\">- </span>             <span class=\"s1\">&#39;-DHEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line d-r\" data-line=\"70\"><span class=\"d-s\">- </span>             <span class=\"n\">f_other</span><span class=\"o\">.</span><span class=\"n\">name</span>\n</span><span class=\"line d-a\" data-line=\"70\"><span class=\"d-s\">+ </span>            <span class=\"p\">[</span><span class=\"s1\">&#39;diff3&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"71\"><span class=\"d-s\">+ </span>             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"72\"><span class=\"d-s\">+ </span>             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;BASE&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_base</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"73\"><span class=\"d-s\">+ </span>             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_other</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"74\"><span class=\"d-s\">  </span>            <span class=\"p\">],</span> <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"75\"><span class=\"d-s\">  </span>            <span class=\"n\">output</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"76\"><span class=\"d-s\">+ </span>            <span class=\"k\">assert</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">returncode</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"78\"><span class=\"d-s\">  </span>        <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "bbb087d7323a273996516a4d17c1cd933298d16a", "ugit/cli.py": "9b0346f321f26f08647e00da3852dc6db04bee97", "ugit/data.py": "27b64966e1b06b2bf04a38dead7ca04779f21d32", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275"}}, {"oid": "349fe1a73ec4040735caef7c777a1e0223304896", "id": "fast-forward-merge", "title": "merge: Fast-forward merge", "message": "<p>So far we've always looked at merges as if they combine two separate lines of development, like so:</p>\n<pre><code>                HEAD\n                v\no---o---o---o---o\n     \\\n      --o---o\n            ^\n            some-branch</code></pre>\n<p>And the result is:</p>\n<pre><code>o---o---o---o---o\n     \\           \\\n      --o---o-----o &lt; HEAD\n            ^\n            some-branch</code></pre>\n<p>But there is an edge case worth talking about - what if HEAD didn't advance in parallel to the branch, and we have this following situation?</p>\n<pre><code>    HEAD\n    v\no---o\n     \\\n      --o---o\n            ^\n            some-branch</code></pre>\n<p>Currently our code doesn't care and when merging HEAD and <em>some-branch</em>, it would create a merge commit like this:</p>\n<pre><code>o---o---------\\\n     \\         \\\n      --o---o---o &lt; HEAD\n            ^\n            some-branch</code></pre>\n<p>But this commit doesn't carry any information! We could get rid of it and instead advance HEAD to point the some-branch directly:</p>\n<pre><code>o---o       HEAD\n     \\      v\n      --o---o\n            ^\n            some-branch</code></pre>\n<p>This type of merge is called a \"fast-forward\" merge.</p>\n<p>In order to know if we can perform a fast-forward merge we need to check if HEAD is an ancestor of the branch that we want to merge into. If the common ancestor of HEAD and <em>some-branch</em> is HEAD itself it means that in particular HEAD is an ancestor of <em>some-branch</em>. That's why in <code>merge</code> we're going to check if <code>merge_base == HEAD</code>. If so, we will just update HEAD to the new location and read that tree.</p>\n<p>(There are some cases where you might still want to create a merge commit even if you can do a fast-forward merge. For example you might want to document the fact that a merge has occured. We'll ignore this usecase for now.)</p>\n", "diff": {"ugit/base.py": {"changed_lines": [156, 157, 158, 159, 160, 161, 162, 163, 166, 167], "hunks": [{"title": "@@ -151,12 +151,20 @@ def merge (other):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"151\"><span class=\"d-s\">  </span>    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\"><span class=\"d-s\">  </span>    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"153\"><span class=\"d-s\">  </span>    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"154\"><span class=\"d-s\">- </span>    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"154\"><span class=\"d-s\">- </span>    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\"><span class=\"d-s\">  </span>    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"156\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line d-a\" data-line=\"157\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"158\"><span class=\"d-s\">+ </span>        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"159\"><span class=\"d-s\">+ </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"160\"><span class=\"d-s\">+ </span>                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"161\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"162\"><span class=\"d-s\">+ </span>        <span class=\"k\">return</span>\n</span><span class=\"line d-a\" data-line=\"163\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"164\"><span class=\"d-s\">  </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"166\"><span class=\"d-s\">+ </span>    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"167\"><span class=\"d-s\">+ </span>    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\"><span class=\"d-s\">  </span>    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "aeed06b14e1078b16198227db055c0066ee901a7", "ugit/cli.py": "9b0346f321f26f08647e00da3852dc6db04bee97", "ugit/data.py": "27b64966e1b06b2bf04a38dead7ca04779f21d32", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275"}}, {"oid": "77901b25be1402241f4a82b69aa078b670d322b8", "id": "change-git-directory", "title": "data: Allow git directory change", "message": "<p>We're going to implement repository syncronization soon (<code>fetch</code>, <code>push</code>). In preparation for that, we need to allow ugit to change the current <code>GIT_DIR</code>, so that we can temporarily look at different repositories while syncronizing.</p>\n<p>Let's use <code>contextmanager</code> to allow the change to be performed in a <code>with</code> statement so that directory changes are easily stackable and revertible.</p>\n", "diff": {"ugit/cli.py": {"changed_lines": [13, 14, 15], "hunks": [{"title": "@@ -10,8 +10,9 @@ from . import diff", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"10\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"11\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"12\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line d-r\" data-line=\"13\"><span class=\"d-s\">- </span>    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line d-r\" data-line=\"13\"><span class=\"d-s\">- </span>    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"13\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"14\"><span class=\"d-s\">+ </span>        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"15\"><span class=\"d-s\">+ </span>        <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"17\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"18\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [5, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17], "hunks": [{"title": "@@ -2,8 +2,19 @@ import hashlib", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"2\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line d-a\" data-line=\"5\"><span class=\"d-s\">+ </span><span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"7\"><span class=\"d-s\">- </span><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;.ugit&#39;</span>\n</span><span class=\"line d-a\" data-line=\"7\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"8\"><span class=\"d-s\">+ </span><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line d-a\" data-line=\"9\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"10\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"11\"><span class=\"d-s\">+ </span><span class=\"nd\">@contextmanager</span>\n</span><span class=\"line d-a\" data-line=\"12\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">new_dir</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"13\"><span class=\"d-s\">+ </span>    <span class=\"k\">global</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line d-a\" data-line=\"14\"><span class=\"d-s\">+ </span>    <span class=\"n\">old_dir</span> <span class=\"o\">=</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line d-a\" data-line=\"15\"><span class=\"d-s\">+ </span>    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">new_dir</span><span class=\"si\">}</span><span class=\"s1\">/.ugit&#39;</span>\n</span><span class=\"line d-a\" data-line=\"16\"><span class=\"d-s\">+ </span>    <span class=\"k\">yield</span>\n</span><span class=\"line d-a\" data-line=\"17\"><span class=\"d-s\">+ </span>    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"n\">old_dir</span>\n</span><span class=\"line\" data-line=\"18\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"19\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"20\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "aeed06b14e1078b16198227db055c0066ee901a7", "ugit/cli.py": "991dcd3e7d18c1e48b64536aa49ca74c40932ffa", "ugit/data.py": "105e550dc93bd4849f50de04a171fd8b7825e4c3", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275"}}, {"oid": "5051e7282d68eee3471bcbac1b489b7947483e44", "id": "print-remote-refs", "title": "fetch: Print remote refs", "message": "<p>In the following changes, we're going to work on the <code>fetch</code> command. The objective of this command is to download refs and associated objects from a remote repository.</p>\n<p>In the bigger picture, it will allow us to synchronize different repositories. For example let's assume that two people (me and colleague) collaborate on the same repository and each has a copy of the repository. Initially we have the same commits, but then the colleague adds another commit on <em>master</em> (marked with a \"*\").</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                master\n                v\no---o---o---o---o</code></pre></li>\n<li><p>My colleagues repository:</p>\n<pre><code>                    master\n                    v\no---o---o---o---o---*</code></pre></li>\n</ul>\n<p>I would like the synchronize my (local) repository with his (remote) repository. So I will run <code>ugit fetch /path/to/remote/repo</code> which will bring remote refs and commits:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                master\n                v\no---o---o---o---o---*\n                    ^\n                    remote/master</code></pre></li>\n</ul>\n<p>Note that the remote <em>master</em> ref is namespaced under \"remote/\" to distinguish it from my <em>master</em>. Next, if I want to synchronize my <em>master</em> I can do <code>ugit merge remote/master</code> (Assuming that HEAD points to master):</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                    master\n                    v\no---o---o---o---o---*\n                    ^\n                    remote/master</code></pre></li>\n</ul>\n<p>Implementing the whole <code>fetch</code> command will take some time, but I still wanted to present the end goal. Now we will start working at the first part:</p>\n<p>Let's begin by just listing all refs on the remote repository. <code>fetch</code> will accept the remote repository as an argument, change <code>GIT_DIR</code> to point to the remote repository and list all refs using our battle-tested <code>iter_refs</code> function. Since I want to only print the branches (and not HEAD and such) let's only get the refs that starts with \"refs/heads\".</p>\n<p>Note that I've created a new <em>remote.py</em> module that will contain all our remote synchronization code.</p>\n<p>Also note that we're only going to support remote repositories that are located on the same filesystem, which means that they aren't really \"remote\" as in located on another computer. In our case remote means an external repository, even if it's on the same filesystem. Real Git supports remotes on the same filesystems as well but also other remote repo types such as SSH or HTTP. I don't want to implement remote support over these network protocols because they are much more complicated and I hope that filesystem-based remotes will illustrate the important concepts just as well.</p>\n", "diff": {"ugit/cli.py": {"changed_lines": [10, 94, 95, 96, 97, 241, 242, 243, 244], "hunks": [{"title": "@@ -7,6 +7,7 @@ import textwrap", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"7\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line d-a\" data-line=\"10\"><span class=\"d-s\">+ </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">remote</span>\n</span><span class=\"line\" data-line=\"11\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"12\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"13\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span></code></pre></div>\n"}, {"title": "@@ -90,6 +91,10 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"91\"><span class=\"d-s\">  </span>    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\"><span class=\"d-s\">  </span>    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"94\"><span class=\"d-s\">+ </span>    <span class=\"n\">fetch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"95\"><span class=\"d-s\">+ </span>    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">fetch</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"96\"><span class=\"d-s\">+ </span>    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"97\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -233,3 +238,7 @@ def merge (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"238\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"239\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"240\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"241\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"242\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"243\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"244\"><span class=\"d-s\">+ </span>    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/remote.py": {"changed_lines": [1, 2, 3, 4, 5, 6, 7, 8], "hunks": [{"title": "@@ -0,0 +1,8 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line d-a\" data-line=\"1\"><span class=\"d-s\">+ </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line d-a\" data-line=\"2\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"3\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"4\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"5\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Will fetch the following refs:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"6\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"7\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"8\"><span class=\"d-s\">+ </span>            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;- </span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "aeed06b14e1078b16198227db055c0066ee901a7", "ugit/cli.py": "e311856f25066367150572e4f0cf811ceec411ec", "ugit/data.py": "105e550dc93bd4849f50de04a171fd8b7825e4c3", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "6f6f0d9cb1fa42ff681a80a53209497d0bbfb8cf"}}, {"oid": "15c497a441255e63fba152dba6bc432b0ee02c43", "id": "print-remote-refs-refactor", "title": "fetch: Retrieve remote refs in a separate function", "message": "<p>This is a small refactoring change that will be useful for later. I created a separate function to get all ref names and values from a remote repository, and then called it from <code>fetch</code>.</p>\n", "diff": {"ugit/remote.py": {"changed_lines": [6, 7, 8, 9, 10, 12], "hunks": [{"title": "@@ -3,6 +3,10 @@ from . import data", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Will fetch the following refs:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"6\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"7\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;- </span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"8\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"9\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"10\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\"><span class=\"d-s\">  </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"12\"><span class=\"d-s\">- </span>        <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"12\"><span class=\"d-s\">- </span>            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;- </span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"12\"><span class=\"d-s\">+ </span>        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "aeed06b14e1078b16198227db055c0066ee901a7", "ugit/cli.py": "e311856f25066367150572e4f0cf811ceec411ec", "ugit/data.py": "105e550dc93bd4849f50de04a171fd8b7825e4c3", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "41cfd1c04d68e3d4af22d4f7133b888af4e84228"}}, {"oid": "f6459a3f3739477b06b929bebea38da5c8256793", "id": "fetch-remove-ref-values", "title": "fetch: Download remote ref values", "message": "<p>Instead of just printing remote refs, let's actually save them locally. We're going to use a separate ref namespace for remote refs, so if the remote repository has <em>refs/heads/master</em> we're going to save it locally as <em>refs/remote/master</em> to distinguish the remote master from the local master. Visually,</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---o</code></pre></li>\n<li><p>My colleagues repository:</p>\n<pre><code>                    refs/heads/master\n                    v\no---o---o---o---o---*</code></pre></li>\n</ul>\n<p>And after running <code>fetch</code>,</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---o   *\n                    ^\n                    refs/remote/master</code></pre></li>\n</ul>\n<p>Just note that the remote commit is still missing from my object store, so <em>refs/remote/master</em> points to a non-existing object and any attempts to use it will cause an error.</p>\n<p>We're going to fix the error in the next change.</p>\n<p>Note that real Git supports multiple remotes, and each remote has a name. For example, if there is a remote named \"origin\", its branches would go under <em>refs/remote/origin/</em>. But in ugit we assume for simplicity that there's only one remote and just put its branches under <em>refs/remote/</em>.</p>\n", "diff": {"ugit/remote.py": {"changed_lines": [1, 2, 6, 7, 8, 9, 11, 12, 13, 14, 15, 16, 17, 18], "hunks": [{"title": "@@ -1,10 +1,21 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line d-a\" data-line=\"1\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line d-a\" data-line=\"2\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"6\"><span class=\"d-s\">+ </span><span class=\"n\">REMOTE_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/heads/&#39;</span>\n</span><span class=\"line d-a\" data-line=\"7\"><span class=\"d-s\">+ </span><span class=\"n\">LOCAL_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/remote/&#39;</span>\n</span><span class=\"line d-a\" data-line=\"8\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"9\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"11\"><span class=\"d-s\">- </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Will fetch the following refs:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"11\"><span class=\"d-s\">- </span>    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-r\" data-line=\"11\"><span class=\"d-s\">- </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;- </span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"11\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Get refs from server</span>\n</span><span class=\"line d-a\" data-line=\"12\"><span class=\"d-s\">+ </span>    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"13\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"14\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Update local refs to match server</span>\n</span><span class=\"line d-a\" data-line=\"15\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"16\"><span class=\"d-s\">+ </span>        <span class=\"n\">refname</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"17\"><span class=\"d-s\">+ </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">LOCAL_REFS_BASE</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"18\"><span class=\"d-s\">+ </span>                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"19\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"20\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"21\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "aeed06b14e1078b16198227db055c0066ee901a7", "ugit/cli.py": "e311856f25066367150572e4f0cf811ceec411ec", "ugit/data.py": "105e550dc93bd4849f50de04a171fd8b7825e4c3", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "3247b5080b716d29e58bce72046bd76ac43364ab"}}, {"oid": "5e1564c9d91679a5779ec4f5ba5fb3731e6d3127", "id": "fetch-remote-refs-objects", "title": "fetch: Download missing objects pointed by remote refs", "message": "<p>In addition to fetching the refs, we're going to fetch the objects that the refs points to. For that we will need some extra functions:</p>\n<h1>In data.py</h1>\n<p>We will add <code>fetch_object_if_missing</code> to conditionally copy objects from a remote repository by OID.</p>\n<h1>In base.py</h1>\n<p>We will add <code>iter_objects_in_commits</code>, which will take a list of commit OIDs and return all objects that are reachable from these commits. The code is a bit large, but it mostly relies on <code>iter_commits_and_parents</code> to get a list of all commits and then recursively iterates on the trees in each commit.</p>\n<p>It's important to note that before accessing an OID we yield it, to give the caller a chance to fetch it if it's missing.</p>\n<h1>In remote.py</h1>\n<p>We've done the heavy lifting in <em>data.py</em> and <em>base.py</em>, so in <code>fetch</code> we just need to iterate over all objects and fetch the missing ones.</p>\n<p>And that's it! We're done, <code>fetch</code> works! It's not the most efficient implementation but it's very functional.</p>\n<p>Now you can use <code>fetch</code> followed by a <code>merge</code> to synchronize you current working branch to a remote repository.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [228, 229, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269], "hunks": [{"title": "@@ -225,6 +225,8 @@ def get_commit (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"225\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"226\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"227\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"228\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line d-a\" data-line=\"229\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"230\"><span class=\"d-s\">  </span>    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"231\"><span class=\"d-s\">  </span>    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}, {"title": "@@ -242,6 +244,29 @@ def iter_commits_and_parents (oids):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"244\"><span class=\"d-s\">  </span>        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"245\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"246\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"247\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"248\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line d-a\" data-line=\"249\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line d-a\" data-line=\"250\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"251\"><span class=\"d-s\">+ </span>    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"252\"><span class=\"d-s\">+ </span>    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"253\"><span class=\"d-s\">+ </span>        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"254\"><span class=\"d-s\">+ </span>        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"255\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"256\"><span class=\"d-s\">+ </span>            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"257\"><span class=\"d-s\">+ </span>                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"258\"><span class=\"d-s\">+ </span>                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"259\"><span class=\"d-s\">+ </span>                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"260\"><span class=\"d-s\">+ </span>                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"261\"><span class=\"d-s\">+ </span>                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"262\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"263\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"264\"><span class=\"d-s\">+ </span>        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"265\"><span class=\"d-s\">+ </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"266\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"267\"><span class=\"d-s\">+ </span>            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"268\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"269\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"270\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"271\"><span class=\"d-s\">  </span>    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [3, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112], "hunks": [{"title": "@@ -1,5 +1,6 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line d-a\" data-line=\"3\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">shutil</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n</span></code></pre></div>\n"}, {"title": "@@ -97,3 +98,15 @@ def get_object (oid, expected='blob'):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span>    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span><span class=\"line d-a\" data-line=\"101\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"102\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"104\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"105\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"106\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"107\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_git_dir</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"108\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"109\"><span class=\"d-s\">+ </span>        <span class=\"k\">return</span>\n</span><span class=\"line d-a\" data-line=\"110\"><span class=\"d-s\">+ </span>    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line d-a\" data-line=\"111\"><span class=\"d-s\">+ </span>    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"112\"><span class=\"d-s\">+ </span>                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/remote.py": {"changed_lines": [3, 15, 16, 17, 18], "hunks": [{"title": "@@ -1,5 +1,6 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"3\"><span class=\"d-s\">+ </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -11,6 +12,10 @@ def fetch (remote_path):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"12\"><span class=\"d-s\">  </span>    <span class=\"c1\"># Get refs from server</span>\n</span><span class=\"line\" data-line=\"13\"><span class=\"d-s\">  </span>    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"14\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"15\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Fetch missing objects by iterating and fetching on demand</span>\n</span><span class=\"line d-a\" data-line=\"16\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">()):</span>\n</span><span class=\"line d-a\" data-line=\"17\"><span class=\"d-s\">+ </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"18\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"19\"><span class=\"d-s\">  </span>    <span class=\"c1\"># Update local refs to match server</span>\n</span><span class=\"line\" data-line=\"20\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"21\"><span class=\"d-s\">  </span>        <span class=\"n\">refname</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "b4c67666133ff59dbff8b8e02245f57505b48f5e", "ugit/cli.py": "e311856f25066367150572e4f0cf811ceec411ec", "ugit/data.py": "8419a7ae5165d5ed3df63c9bc9f56fe8b4ef8885", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "3556aa9b29eb4ca66da463c6fa80e524c9569d93"}}], "objects": {"f76da3e52397760e5a4bea91cd8c311726ec7afe": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"106\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"108\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"115\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"117\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"119\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"130\">\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"133\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">\n</span><span class=\"line\" data-line=\"137\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"138\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"140\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"143\">\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"147\">\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"150\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">\n</span><span class=\"line\" data-line=\"155\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"156\">\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\">\n</span><span class=\"line\" data-line=\"161\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"162\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">\n</span><span class=\"line\" data-line=\"165\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"167\">\n</span><span class=\"line\" data-line=\"168\">\n</span><span class=\"line\" data-line=\"169\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"170\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"171\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"172\">\n</span><span class=\"line\" data-line=\"173\">\n</span><span class=\"line\" data-line=\"174\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"175\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"176\">\n</span><span class=\"line\" data-line=\"177\">\n</span><span class=\"line\" data-line=\"178\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"179\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"180\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"181\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"182\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"183\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"184\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"185\">\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"188\">\n</span><span class=\"line\" data-line=\"189\">\n</span><span class=\"line\" data-line=\"190\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"192\">\n</span><span class=\"line\" data-line=\"193\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"194\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"195\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"196\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"197\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"198\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"199\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"200\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"201\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"202\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"203\">\n</span><span class=\"line\" data-line=\"204\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"205\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"206\">\n</span><span class=\"line\" data-line=\"207\">\n</span><span class=\"line\" data-line=\"208\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"209\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"210\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"213\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"214\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"215\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"216\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"217\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"218\">\n</span><span class=\"line\" data-line=\"219\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"220\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"221\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"223\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"224\">\n</span><span class=\"line\" data-line=\"225\">\n</span><span class=\"line\" data-line=\"226\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"227\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"231\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"232\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"233\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"234\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"236\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"237\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"238\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"239\">\n</span><span class=\"line\" data-line=\"240\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"241\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"242\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"243\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"244\">\n</span><span class=\"line\" data-line=\"245\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"246\">\n</span><span class=\"line\" data-line=\"247\">\n</span><span class=\"line\" data-line=\"248\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"249\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "c95f0aeb82b2b127c42a1f1b5cf356f145641f47": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"97\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\">\n</span><span class=\"line\" data-line=\"113\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"114\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"115\">\n</span><span class=\"line\" data-line=\"116\">\n</span><span class=\"line\" data-line=\"117\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"121\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">\n</span><span class=\"line\" data-line=\"124\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"127\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"130\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"131\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\">\n</span><span class=\"line\" data-line=\"134\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"136\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"137\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"138\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"140\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"144\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"145\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"147\">\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"150\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"151\">\n</span><span class=\"line\" data-line=\"152\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\">\n</span><span class=\"line\" data-line=\"157\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\">\n</span><span class=\"line\" data-line=\"161\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"162\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">\n</span><span class=\"line\" data-line=\"165\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"166\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"167\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"168\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"169\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"170\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"171\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"172\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"173\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"177\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"180\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"181\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"182\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"183\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"184\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"185\">\n</span><span class=\"line\" data-line=\"186\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"187\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"188\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"189\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"190\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"193\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"194\">\n</span><span class=\"line\" data-line=\"195\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"196\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"197\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"198\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"199\">\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"204\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"205\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"207\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">\n</span><span class=\"line\" data-line=\"209\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"210\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"211\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"212\">\n</span><span class=\"line\" data-line=\"213\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"215\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"216\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"217\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"218\">\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"221\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"222\">\n</span><span class=\"line\" data-line=\"223\">\n</span><span class=\"line\" data-line=\"224\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"225\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "27b64966e1b06b2bf04a38dead7ca04779f21d32": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"n\">RefValue</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;RefValue&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;symbolic&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;value&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">assert</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;ref: </span><span class=\"si\">{</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"24\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"29\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\"><span class=\"k\">def</span> <span class=\"nf\">delete_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\"><span class=\"k\">def</span> <span class=\"nf\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"46\">            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">symbolic</span> <span class=\"o\">=</span> <span class=\"nb\">bool</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;ref:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"k\">if</span> <span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;:&#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"51\">        <span class=\"k\">if</span> <span class=\"n\">deref</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">            <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">return</span> <span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"n\">symbolic</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\"><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">refname</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"66\">        <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"n\">deref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">if</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span>\n</span><span class=\"line\" data-line=\"69\">\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"80\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"81\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">partition</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"87\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span></code></pre></div>\n", "ca2cbac108846b70d0ac9a391ed22678192d2afc": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"106\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"108\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"115\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"117\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"119\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"130\">\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"133\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">\n</span><span class=\"line\" data-line=\"137\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"138\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"140\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"143\">\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"147\">\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"150\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">\n</span><span class=\"line\" data-line=\"155\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"156\">\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\">\n</span><span class=\"line\" data-line=\"161\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"162\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">list</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"165\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"166\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"167\">\n</span><span class=\"line\" data-line=\"168\">\n</span><span class=\"line\" data-line=\"169\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"170\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\">\n</span><span class=\"line\" data-line=\"173\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"174\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\">\n</span><span class=\"line\" data-line=\"177\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"178\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"179\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"180\">\n</span><span class=\"line\" data-line=\"181\">\n</span><span class=\"line\" data-line=\"182\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"183\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"184\">\n</span><span class=\"line\" data-line=\"185\">\n</span><span class=\"line\" data-line=\"186\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"187\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"188\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"189\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"190\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"192\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"193\">\n</span><span class=\"line\" data-line=\"194\">\n</span><span class=\"line\" data-line=\"195\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\">\n</span><span class=\"line\" data-line=\"198\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"199\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"205\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"206\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"207\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"208\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"209\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"210\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"214\">\n</span><span class=\"line\" data-line=\"215\">\n</span><span class=\"line\" data-line=\"216\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"218\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"223\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"224\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"225\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"226\">\n</span><span class=\"line\" data-line=\"227\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"229\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"230\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"231\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"232\">\n</span><span class=\"line\" data-line=\"233\">\n</span><span class=\"line\" data-line=\"234\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"238\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"239\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"240\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"241\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"243\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"244\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"245\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"246\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"247\">\n</span><span class=\"line\" data-line=\"248\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"249\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"250\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"251\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"252\">\n</span><span class=\"line\" data-line=\"253\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"254\">\n</span><span class=\"line\" data-line=\"255\">\n</span><span class=\"line\" data-line=\"256\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"257\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "9b0346f321f26f08647e00da3852dc6db04bee97": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"102\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"107\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"112\">\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"115\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"116\">\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"130\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"131\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"132\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"133\">\n</span><span class=\"line\" data-line=\"134\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"135\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">\n</span><span class=\"line\" data-line=\"139\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"142\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"144\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"145\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"146\">\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"148\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"149\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"150\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"152\">\n</span><span class=\"line\" data-line=\"153\">\n</span><span class=\"line\" data-line=\"154\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"155\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"156\">\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"160\">\n</span><span class=\"line\" data-line=\"161\">\n</span><span class=\"line\" data-line=\"162\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"163\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"164\">\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">\n</span><span class=\"line\" data-line=\"169\">\n</span><span class=\"line\" data-line=\"170\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"171\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"172\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"173\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"174\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"175\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"176\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"177\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"178\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\">\n</span><span class=\"line\" data-line=\"181\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"182\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"185\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"186\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"187\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"188\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"189\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"190\">\n</span><span class=\"line\" data-line=\"191\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"192\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"193\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"194\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"195\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"198\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"199\">\n</span><span class=\"line\" data-line=\"200\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"201\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"202\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"203\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"204\">\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"207\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"209\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"210\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"211\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"212\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"213\">\n</span><span class=\"line\" data-line=\"214\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"215\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"216\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"217\">\n</span><span class=\"line\" data-line=\"218\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"219\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"220\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"221\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"223\">\n</span><span class=\"line\" data-line=\"224\">\n</span><span class=\"line\" data-line=\"225\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"226\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"227\">\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"231\">\n</span><span class=\"line\" data-line=\"232\">\n</span><span class=\"line\" data-line=\"233\"><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"234\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span></code></pre></div>\n", "bbb087d7323a273996516a4d17c1cd933298d16a": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"106\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"109\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"156\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"157\">\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"161\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"162\">\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"165\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">list</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"166\">\n</span><span class=\"line\" data-line=\"167\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"168\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"169\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"177\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"181\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"182\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\">\n</span><span class=\"line\" data-line=\"185\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"186\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"187\">\n</span><span class=\"line\" data-line=\"188\">\n</span><span class=\"line\" data-line=\"189\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"190\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"192\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"193\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"194\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"195\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\">\n</span><span class=\"line\" data-line=\"198\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"199\">\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"203\">\n</span><span class=\"line\" data-line=\"204\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"205\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"207\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"209\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"210\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"211\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"212\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"213\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"214\">\n</span><span class=\"line\" data-line=\"215\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"216\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"217\">\n</span><span class=\"line\" data-line=\"218\">\n</span><span class=\"line\" data-line=\"219\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"220\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"221\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"222\">\n</span><span class=\"line\" data-line=\"223\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"224\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"225\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"226\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"227\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"229\">\n</span><span class=\"line\" data-line=\"230\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"231\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"232\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"233\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"234\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"235\">\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"238\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"239\">\n</span><span class=\"line\" data-line=\"240\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"241\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"243\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"244\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"245\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"246\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"247\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"248\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"249\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"250\">\n</span><span class=\"line\" data-line=\"251\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"252\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"253\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"254\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"255\">\n</span><span class=\"line\" data-line=\"256\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"257\">\n</span><span class=\"line\" data-line=\"258\">\n</span><span class=\"line\" data-line=\"259\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"260\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "9c6fbcf4088724b6a5d917f550a4a39c33218275": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">defaultdict</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">tempfile</span> <span class=\"kn\">import</span> <span class=\"n\">NamedTemporaryFile</span> <span class=\"k\">as</span> <span class=\"n\">Temp</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">compare_trees</span> <span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">trees</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"n\">defaultdict</span> <span class=\"p\">(</span><span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"kc\">None</span><span class=\"p\">]</span> <span class=\"o\">*</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">trees</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">tree</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span> <span class=\"p\">(</span><span class=\"n\">trees</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">        <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">            <span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oids</span> <span class=\"ow\">in</span> <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"k\">yield</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\"><span class=\"k\">def</span> <span class=\"nf\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"k\">if</span> <span class=\"n\">o_from</span> <span class=\"o\">!=</span> <span class=\"n\">o_to</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"n\">action</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;new file&#39;</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">o_from</span> <span class=\"k\">else</span>\n</span><span class=\"line\" data-line=\"23\">                      <span class=\"s1\">&#39;deleted&#39;</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">o_to</span> <span class=\"k\">else</span>\n</span><span class=\"line\" data-line=\"24\">                      <span class=\"s1\">&#39;modified&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">yield</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\"><span class=\"k\">def</span> <span class=\"nf\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"k\">if</span> <span class=\"n\">o_from</span> <span class=\"o\">!=</span> <span class=\"n\">o_to</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">output</span> <span class=\"o\">+=</span> <span class=\"n\">diff_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\"><span class=\"k\">def</span> <span class=\"nf\">diff_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">with</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_from</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_to</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"k\">for</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"p\">((</span><span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">f_from</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_to</span><span class=\"p\">,</span> <span class=\"n\">f_to</span><span class=\"p\">)):</span>\n</span><span class=\"line\" data-line=\"39\">            <span class=\"k\">if</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"40\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"41\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">        <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"44\">            <span class=\"p\">[</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--unified&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--show-c-function&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"45\">             <span class=\"s1\">&#39;--label&#39;</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;a/</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_from</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"46\">             <span class=\"s1\">&#39;--label&#39;</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;b/</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_to</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"47\">            <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"48\">            <span class=\"n\">output</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"n\">tree</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"k\">return</span> <span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">with</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_base</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_HEAD</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_other</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">        <span class=\"c1\"># Write blobs to files</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"k\">for</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"p\">((</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">f_base</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_other</span><span class=\"p\">,</span> <span class=\"n\">f_other</span><span class=\"p\">)):</span>\n</span><span class=\"line\" data-line=\"65\">            <span class=\"k\">if</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\">        <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"p\">[</span><span class=\"s1\">&#39;diff3&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"71\">             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"72\">             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;BASE&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_base</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"73\">             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_other</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"74\">            <span class=\"p\">],</span> <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"75\">            <span class=\"n\">output</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"76\">            <span class=\"k\">assert</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">returncode</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span></code></pre></div>\n", "aeed06b14e1078b16198227db055c0066ee901a7": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"106\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"109\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"158\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"160\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"161\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"162\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">list</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"176\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"177\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"181\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"182\">\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"185\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\">\n</span><span class=\"line\" data-line=\"188\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"189\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"190\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\">\n</span><span class=\"line\" data-line=\"193\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"194\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"195\">\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"198\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"199\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"200\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"201\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"204\">\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"207\">\n</span><span class=\"line\" data-line=\"208\">\n</span><span class=\"line\" data-line=\"209\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"210\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"215\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"216\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"217\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"218\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"219\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"220\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"222\">\n</span><span class=\"line\" data-line=\"223\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"224\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"225\">\n</span><span class=\"line\" data-line=\"226\">\n</span><span class=\"line\" data-line=\"227\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"228\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"229\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"230\">\n</span><span class=\"line\" data-line=\"231\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"232\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"233\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"234\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"235\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"236\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"237\">\n</span><span class=\"line\" data-line=\"238\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"239\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"240\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"241\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\">\n</span><span class=\"line\" data-line=\"245\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"246\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"247\">\n</span><span class=\"line\" data-line=\"248\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"249\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"250\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"251\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"252\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"253\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"254\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"255\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"256\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"257\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"258\">\n</span><span class=\"line\" data-line=\"259\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"260\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"261\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"262\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"263\">\n</span><span class=\"line\" data-line=\"264\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"265\">\n</span><span class=\"line\" data-line=\"266\">\n</span><span class=\"line\" data-line=\"267\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"268\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "991dcd3e7d18c1e48b64536aa49ca74c40932ffa": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"14\">        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">\n</span><span class=\"line\" data-line=\"88\">    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">\n</span><span class=\"line\" data-line=\"93\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"98\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"103\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"107\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"127\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"131\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"132\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"133\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"134\">\n</span><span class=\"line\" data-line=\"135\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"136\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"138\">\n</span><span class=\"line\" data-line=\"139\">\n</span><span class=\"line\" data-line=\"140\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"141\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"142\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"145\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"146\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"147\">\n</span><span class=\"line\" data-line=\"148\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"149\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"150\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"153\">\n</span><span class=\"line\" data-line=\"154\">\n</span><span class=\"line\" data-line=\"155\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"156\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"157\">\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"160\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"161\">\n</span><span class=\"line\" data-line=\"162\">\n</span><span class=\"line\" data-line=\"163\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">\n</span><span class=\"line\" data-line=\"167\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"168\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\">\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"172\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"173\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"174\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"175\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"176\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"177\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"178\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"179\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"180\">\n</span><span class=\"line\" data-line=\"181\">\n</span><span class=\"line\" data-line=\"182\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"183\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"184\">\n</span><span class=\"line\" data-line=\"185\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"186\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"187\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"188\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"189\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"190\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"193\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"194\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"195\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"196\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"197\">\n</span><span class=\"line\" data-line=\"198\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"199\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"202\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"203\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\">\n</span><span class=\"line\" data-line=\"207\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"208\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"209\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"210\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"211\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"212\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"213\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"214\">\n</span><span class=\"line\" data-line=\"215\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"216\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"217\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"218\">\n</span><span class=\"line\" data-line=\"219\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"220\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"221\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"222\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"223\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"224\">\n</span><span class=\"line\" data-line=\"225\">\n</span><span class=\"line\" data-line=\"226\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"227\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\">\n</span><span class=\"line\" data-line=\"230\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"231\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"232\">\n</span><span class=\"line\" data-line=\"233\">\n</span><span class=\"line\" data-line=\"234\"><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span></code></pre></div>\n", "105e550dc93bd4849f50de04a171fd8b7825e4c3": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"nd\">@contextmanager</span>\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">new_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"k\">global</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">old_dir</span> <span class=\"o\">=</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">new_dir</span><span class=\"si\">}</span><span class=\"s1\">/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">yield</span>\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"n\">old_dir</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\"><span class=\"n\">RefValue</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;RefValue&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;symbolic&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;value&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">assert</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"33\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;ref: </span><span class=\"si\">{</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"45\">\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\"><span class=\"k\">def</span> <span class=\"nf\">delete_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\"><span class=\"k\">def</span> <span class=\"nf\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"57\">            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">symbolic</span> <span class=\"o\">=</span> <span class=\"nb\">bool</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;ref:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"k\">if</span> <span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;:&#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"62\">        <span class=\"k\">if</span> <span class=\"n\">deref</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"63\">            <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">    <span class=\"k\">return</span> <span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"n\">symbolic</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\"><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"71\">        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\">    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">refname</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"76\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"77\">        <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"n\">deref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">if</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"86\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"92\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">partition</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span></code></pre></div>\n", "e311856f25066367150572e4f0cf811ceec411ec": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">remote</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">fetch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">fetch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"107\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">\n</span><span class=\"line\" data-line=\"116\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"117\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">\n</span><span class=\"line\" data-line=\"120\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"121\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">\n</span><span class=\"line\" data-line=\"124\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"129\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"130\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"131\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"132\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"133\">\n</span><span class=\"line\" data-line=\"134\">\n</span><span class=\"line\" data-line=\"135\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"137\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"138\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"139\">\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"143\">\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"147\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"148\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"149\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"150\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"151\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"152\">\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"155\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"156\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"158\">\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"161\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"162\">\n</span><span class=\"line\" data-line=\"163\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"165\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"166\">\n</span><span class=\"line\" data-line=\"167\">\n</span><span class=\"line\" data-line=\"168\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"169\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"177\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"178\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"179\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"180\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"181\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"182\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"183\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"184\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"185\">\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"188\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"189\">\n</span><span class=\"line\" data-line=\"190\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"192\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"193\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"194\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"195\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"198\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"199\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"200\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"201\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"202\">\n</span><span class=\"line\" data-line=\"203\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"204\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"207\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"208\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"209\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"210\">\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"215\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"216\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"218\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"221\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"223\">\n</span><span class=\"line\" data-line=\"224\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"225\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"226\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"227\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"228\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"229\">\n</span><span class=\"line\" data-line=\"230\">\n</span><span class=\"line\" data-line=\"231\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"232\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"233\">\n</span><span class=\"line\" data-line=\"234\">\n</span><span class=\"line\" data-line=\"235\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"236\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"237\">\n</span><span class=\"line\" data-line=\"238\">\n</span><span class=\"line\" data-line=\"239\"><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"240\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"241\">\n</span><span class=\"line\" data-line=\"242\">\n</span><span class=\"line\" data-line=\"243\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"244\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "6f6f0d9cb1fa42ff681a80a53209497d0bbfb8cf": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"5\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Will fetch the following refs:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"6\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"7\">        <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"8\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;- </span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "41cfd1c04d68e3d4af22d4f7133b888af4e84228": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"5\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Will fetch the following refs:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"6\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"7\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;- </span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n", "3247b5080b716d29e58bce72046bd76ac43364ab": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"n\">REMOTE_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/heads/&#39;</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"n\">LOCAL_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/remote/&#39;</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"c1\"># Get refs from server</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">    <span class=\"c1\"># Update local refs to match server</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"k\">for</span> <span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"n\">refname</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">LOCAL_REFS_BASE</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"18\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\"><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n", "b4c67666133ff59dbff8b8e02245f57505b48f5e": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"106\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"109\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"158\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"160\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"161\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"162\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">list</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"176\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"177\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"181\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"182\">\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"185\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\">\n</span><span class=\"line\" data-line=\"188\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"189\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"190\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\">\n</span><span class=\"line\" data-line=\"193\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"194\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"195\">\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"198\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"199\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"200\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"201\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"204\">\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"207\">\n</span><span class=\"line\" data-line=\"208\">\n</span><span class=\"line\" data-line=\"209\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"210\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"215\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"216\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"217\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"218\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"219\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"220\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"222\">\n</span><span class=\"line\" data-line=\"223\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"224\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"225\">\n</span><span class=\"line\" data-line=\"226\">\n</span><span class=\"line\" data-line=\"227\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"228\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"229\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"231\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"232\">\n</span><span class=\"line\" data-line=\"233\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"234\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"235\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"236\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"237\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"238\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"239\">\n</span><span class=\"line\" data-line=\"240\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"241\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"243\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"244\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"245\">\n</span><span class=\"line\" data-line=\"246\">\n</span><span class=\"line\" data-line=\"247\"><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"248\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"249\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"250\">\n</span><span class=\"line\" data-line=\"251\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"252\">    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"253\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"254\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"255\">        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"256\">            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"257\">                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"258\">                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"259\">                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"260\">                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"261\">                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"262\">\n</span><span class=\"line\" data-line=\"263\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"264\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"265\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"266\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"267\">            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"268\">\n</span><span class=\"line\" data-line=\"269\">\n</span><span class=\"line\" data-line=\"270\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"271\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"272\">\n</span><span class=\"line\" data-line=\"273\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"274\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"275\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"276\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"277\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"278\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"279\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"280\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"281\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"282\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"283\">\n</span><span class=\"line\" data-line=\"284\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"285\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"286\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"287\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"288\">\n</span><span class=\"line\" data-line=\"289\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"290\">\n</span><span class=\"line\" data-line=\"291\">\n</span><span class=\"line\" data-line=\"292\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"293\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "8419a7ae5165d5ed3df63c9bc9f56fe8b4ef8885": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">shutil</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"nd\">@contextmanager</span>\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">new_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">global</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">old_dir</span> <span class=\"o\">=</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">new_dir</span><span class=\"si\">}</span><span class=\"s1\">/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"17\">    <span class=\"k\">yield</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"n\">old_dir</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\"><span class=\"n\">RefValue</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;RefValue&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;symbolic&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;value&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"k\">assert</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;ref: </span><span class=\"si\">{</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"36\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\"><span class=\"k\">def</span> <span class=\"nf\">delete_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">symbolic</span> <span class=\"o\">=</span> <span class=\"nb\">bool</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;ref:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">if</span> <span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"62\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;:&#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"63\">        <span class=\"k\">if</span> <span class=\"n\">deref</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">return</span> <span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"n\">symbolic</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\"><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"72\">        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"76\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">refname</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"n\">deref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"k\">if</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"87\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">partition</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"100\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\"><span class=\"k\">def</span> <span class=\"nf\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_git_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"k\">if</span> <span class=\"n\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"109\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"112\">                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "3556aa9b29eb4ca66da463c6fa80e524c9569d93": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"n\">REMOTE_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/heads/&#39;</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"n\">LOCAL_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/remote/&#39;</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"c1\"># Get refs from server</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\">    <span class=\"c1\"># Fetch missing objects by iterating and fetching on demand</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"17\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">    <span class=\"c1\"># Update local refs to match server</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">for</span> <span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"n\">refname</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">LOCAL_REFS_BASE</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"23\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\"><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"28\">        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n"}}