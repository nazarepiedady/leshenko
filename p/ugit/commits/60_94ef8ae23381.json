{"commits": [{"oid": "0915b8ed3625e74b74cf1fc0b09848c7810f1d2a", "id": "push-naive", "title": "push: Naive implementation", "message": "<p>The opposite of <code>fetch</code> is <code>push</code>. Instead of downloading remote refs and objects, it uploads objects and synchronizes the local refs to the remote refs. The usecase for this is when you've added some commits and you'd like to update a remote repository so that it's synchronized with your local version.</p>\n<p>Graphically,</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---o</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>        refs/heads/master\n        v\no---o---o</code></pre></li>\n</ul>\n<p>If we would run <code>ugit push /path/to/remote master</code> the result would be:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---o</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---o</code></pre></li>\n</ul>\n<p>We'll create a new <code>push</code> CLI command, we'll add a <code>push_object</code> function to <em>data.py</em>, which would copy a local object to a remote repository and finally we would tie it together in <em>remote.py</em>: Push all objects that are reachable from the branch to the remote (Find them with our beloved <code>iter_objects_in_commits</code>) and synchronize the remote ref to the local ref value.</p>\n<p>This implementation is inefficient, because each time it pushes all objects to the remote repository regardless of objects that exists there. We'll improve it in following changes.</p>\n", "diff": {"ugit/cli.py": {"changed_lines": [98, 99, 100, 101, 102, 250, 251, 252, 253], "hunks": [{"title": "@@ -95,6 +95,11 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"95\"><span class=\"d-s\">  </span>    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">fetch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\"><span class=\"d-s\">  </span>    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"98\"><span class=\"d-s\">+ </span>    <span class=\"n\">push_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;push&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"99\"><span class=\"d-s\">+ </span>    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">push</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"100\"><span class=\"d-s\">+ </span>    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"101\"><span class=\"d-s\">+ </span>    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"102\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"103\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"104\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -242,3 +247,7 @@ def merge_base (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"247\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"248\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"249\"><span class=\"d-s\">  </span>    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"250\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"251\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"252\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"253\"><span class=\"d-s\">+ </span>    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [114, 115, 116, 117, 118, 119, 120], "hunks": [{"title": "@@ -111,3 +111,10 @@ def fetch_object_if_missing (oid, remote_git_dir):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"111\"><span class=\"d-s\">  </span>    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"112\"><span class=\"d-s\">  </span>    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"113\"><span class=\"d-s\">  </span>                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"114\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"115\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"116\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_git_dir</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"117\"><span class=\"d-s\">+ </span>    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line d-a\" data-line=\"118\"><span class=\"d-s\">+ </span>    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"119\"><span class=\"d-s\">+ </span>                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/remote.py": {"changed_lines": [26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42], "hunks": [{"title": "@@ -23,6 +23,23 @@ def fetch (remote_path):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"23\"><span class=\"d-s\">  </span>                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"24\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"25\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"26\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">refname</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"27\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Get refs data</span>\n</span><span class=\"line d-a\" data-line=\"28\"><span class=\"d-s\">+ </span>    <span class=\"n\">local_ref</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line d-a\" data-line=\"29\"><span class=\"d-s\">+ </span>    <span class=\"k\">assert</span> <span class=\"n\">local_ref</span>\n</span><span class=\"line d-a\" data-line=\"30\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"31\"><span class=\"d-s\">+ </span>    <span class=\"n\">objects_to_push</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">({</span><span class=\"n\">local_ref</span><span class=\"p\">})</span>\n</span><span class=\"line d-a\" data-line=\"32\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"33\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Push all objects</span>\n</span><span class=\"line d-a\" data-line=\"34\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">objects_to_push</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"35\"><span class=\"d-s\">+ </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"36\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"37\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Update server ref to our value</span>\n</span><span class=\"line d-a\" data-line=\"38\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"39\"><span class=\"d-s\">+ </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"40\"><span class=\"d-s\">+ </span>                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">local_ref</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"41\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"42\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"43\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\"><span class=\"d-s\">  </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\"><span class=\"d-s\">  </span>        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "c2f773a3cda8125fa06d3f778bad291518f4b0e8", "ugit/cli.py": "02de9f118bd0a4619677475b6e2a7c5b166881dc", "ugit/data.py": "5567162fbf21d98373ad15a9218aa4532d5481e8", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "fd041ae10a8955417a42bd1c4ffc5ac826094aee"}}, {"oid": "0789120e5e6925753bb8e4b056dd3213288bdeb4", "id": "push-only-missing", "title": "push: Send only missing objects", "message": "<p>As mentioned earlier, copying all objects on each push is inefficient because the remote might already have some of them. For example, if the situation is:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---o</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>            refs/heads/master\n            v\no---o---o---o</code></pre></li>\n</ul>\n<p>When we call <code>push</code> on <em>master</em> there's no need to push all 5 commits and associated objects. It's enough to push the latest commit and the objects that were modified in that commit.</p>\n<p>Instead of pushing all objects in <code>remote.push()</code>, let's add a simple check to determine which objects the remote has:</p>\n<ul>\n<li>Take all remote refs that exist on the remote. Since the remote might have refs that point to branches that we didn't pull yet, filter out all refs that point to unknown OIDs.</li>\n<li>Collect into a set all objects that are reachable from the known remote OIDs.</li>\n<li>Collect into a set all objects that are reachable from the local branch that is being pushed.</li>\n<li>Take the difference between the two sets. This effectively gives us the objects that are needed to fully describe the pushed branch but are missing from the remote.</li>\n<li>Push those missing objects.</li>\n</ul>\n<p>Git has more advanced heuristics to determine what objects should be pushed, but we're gonna stop here.</p>\n", "diff": {"ugit/remote.py": {"changed_lines": [28, 32, 33, 34, 35, 36, 38], "hunks": [{"title": "@@ -25,12 +25,17 @@ def fetch (remote_path):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"25\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"26\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">refname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"27\"><span class=\"d-s\">  </span>    <span class=\"c1\"># Get refs data</span>\n</span><span class=\"line d-a\" data-line=\"28\"><span class=\"d-s\">+ </span>    <span class=\"n\">remote_refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\"><span class=\"d-s\">  </span>    <span class=\"n\">local_ref</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"30\"><span class=\"d-s\">  </span>    <span class=\"k\">assert</span> <span class=\"n\">local_ref</span>\n</span><span class=\"line\" data-line=\"31\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"32\"><span class=\"d-s\">- </span>    <span class=\"n\">objects_to_push</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">({</span><span class=\"n\">local_ref</span><span class=\"p\">})</span>\n</span><span class=\"line d-a\" data-line=\"32\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Compute which objects the server doesn&#39;t have</span>\n</span><span class=\"line d-a\" data-line=\"33\"><span class=\"d-s\">+ </span>    <span class=\"n\">known_remote_refs</span> <span class=\"o\">=</span> <span class=\"nb\">filter</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">object_exists</span><span class=\"p\">,</span> <span class=\"n\">remote_refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">())</span>\n</span><span class=\"line d-a\" data-line=\"34\"><span class=\"d-s\">+ </span>    <span class=\"n\">remote_objects</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">known_remote_refs</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"35\"><span class=\"d-s\">+ </span>    <span class=\"n\">local_objects</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">({</span><span class=\"n\">local_ref</span><span class=\"p\">}))</span>\n</span><span class=\"line d-a\" data-line=\"36\"><span class=\"d-s\">+ </span>    <span class=\"n\">objects_to_push</span> <span class=\"o\">=</span> <span class=\"n\">local_objects</span> <span class=\"o\">-</span> <span class=\"n\">remote_objects</span>\n</span><span class=\"line\" data-line=\"37\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"38\"><span class=\"d-s\">- </span>    <span class=\"c1\"># Push all objects</span>\n</span><span class=\"line d-a\" data-line=\"38\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Push missing objects</span>\n</span><span class=\"line\" data-line=\"39\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">objects_to_push</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"40\"><span class=\"d-s\">  </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "c2f773a3cda8125fa06d3f778bad291518f4b0e8", "ugit/cli.py": "02de9f118bd0a4619677475b6e2a7c5b166881dc", "ugit/data.py": "5567162fbf21d98373ad15a9218aa4532d5481e8", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "f99d3ae2456f14260ef39c78e32235d1b5674e4d"}}, {"oid": "3435365c8e9c695aa9be6028489609193c72ac19", "id": "push-dont-allow-force", "title": "push: Don't allow force push", "message": "<p>Our current <code>push</code> implementation isn't safe from a certain kind of race. If two people are working on the same branch that is pushed to a common remote repository, they might overwrite each other's work. Consider this case:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---@</code></pre></li>\n<li><p>My colleague's repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>            refs/heads/master\n            v\no---o---o---o</code></pre></li>\n</ul>\n<p>Note that both me and my colleague are working with the same remote and each of us made a different commit on top of the same commit from the remote repository. Now, if my colleague will <code>push</code>, the state will look like</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---@</code></pre></li>\n<li><p>My colleague's repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n</ul>\n<p>If I don't pay attention and also run <code>push</code>, ugit will happily overwrite my colleague's latest commit, like this:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---@</code></pre></li>\n<li><p>My colleague's repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---@</code></pre></li>\n</ul>\n<p>To prevent it from happening we're going to allow pushing only in two cases:</p>\n<ul>\n<li><p>The ref that we're pushing doesn't exist yet on the remote. It means that it's a new branch and there is no risk of overwriting other's work.</p></li>\n<li><p>If the remote ref does exist, it must point to a commit that is an ancestor of the pushed ref. This ancestry means that the local commit is based on the remote commit, which means that the remote commit not getting overwritten, since it's part of the history of the newly pushed commit.</p></li>\n</ul>\n<p>Let's return the the previous example. Assuming the situtation looks like this:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---@</code></pre></li>\n<li><p>My colleague's repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n</ul>\n<p>If I try to run <code>ugit push master</code>, the new assert will fire, because the <code>$</code> commit isn't a ancestor of the <code>@</code> commit. To reconcile, I need to run <code>ugit fetch</code>, which will retrieve the latest master:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---@\n             \\\n              --$\n                ^\n                refs/remote/master</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n</ul>\n<p>Then I need to run <code>ugit merge remote/master</code>, which will make combine the branches:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                    refs/heads/master\n                    v\no---o---o---o---@---o\n             \\     /\n              --$--\n                ^\n                refs/remote/master</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>                refs/heads/master\n                v\no---o---o---o---$</code></pre></li>\n</ul>\n<p>Only now I can run <code>push</code> successfully, since the <code>$</code> commit which the remote points to is an ancestor of master. After <code>push</code>:</p>\n<ul>\n<li><p>My repository:</p>\n<pre><code>                    refs/heads/master\n                    v\no---o---o---o---@---o &lt; refs/remote/master\n             \\     /\n              --$--</code></pre></li>\n<li><p>Remote repository:</p>\n<pre><code>                    refs/heads/master\n                    v\no---o---o---o---@---o\n             \\     /\n              --$--</code></pre></li>\n</ul>\n<p>BTW, real Git has a CLI option <code>--force</code> to disable this safety check, but we'll skip it here.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [180, 181, 182, 183], "hunks": [{"title": "@@ -177,6 +177,10 @@ def get_merge_base (oid1, oid2):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"177\"><span class=\"d-s\">  </span>            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"178\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"179\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"180\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">maybe_ancestor</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"181\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">maybe_ancestor</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">commit</span><span class=\"p\">})</span>\n</span><span class=\"line d-a\" data-line=\"182\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"183\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"184\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"185\"><span class=\"d-s\">  </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span></code></pre></div>\n"}]}, "ugit/remote.py": {"changed_lines": [29, 33, 34, 35], "hunks": [{"title": "@@ -26,9 +26,13 @@ def fetch (remote_path):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"26\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">refname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"27\"><span class=\"d-s\">  </span>    <span class=\"c1\"># Get refs data</span>\n</span><span class=\"line\" data-line=\"28\"><span class=\"d-s\">  </span>    <span class=\"n\">remote_refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"29\"><span class=\"d-s\">+ </span>    <span class=\"n\">remote_ref</span> <span class=\"o\">=</span> <span class=\"n\">remote_refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\"><span class=\"d-s\">  </span>    <span class=\"n\">local_ref</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"31\"><span class=\"d-s\">  </span>    <span class=\"k\">assert</span> <span class=\"n\">local_ref</span>\n</span><span class=\"line\" data-line=\"32\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"33\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Don&#39;t allow force push</span>\n</span><span class=\"line d-a\" data-line=\"34\"><span class=\"d-s\">+ </span>    <span class=\"k\">assert</span> <span class=\"ow\">not</span> <span class=\"n\">remote_ref</span> <span class=\"ow\">or</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">local_ref</span><span class=\"p\">,</span> <span class=\"n\">remote_ref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"35\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"36\"><span class=\"d-s\">  </span>    <span class=\"c1\"># Compute which objects the server doesn&#39;t have</span>\n</span><span class=\"line\" data-line=\"37\"><span class=\"d-s\">  </span>    <span class=\"n\">known_remote_refs</span> <span class=\"o\">=</span> <span class=\"nb\">filter</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">object_exists</span><span class=\"p\">,</span> <span class=\"n\">remote_refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"38\"><span class=\"d-s\">  </span>    <span class=\"n\">remote_objects</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">known_remote_refs</span><span class=\"p\">))</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "247354ccfe987568136b9c1bb485d262c8924ad5", "ugit/cli.py": "02de9f118bd0a4619677475b6e2a7c5b166881dc", "ugit/data.py": "5567162fbf21d98373ad15a9218aa4532d5481e8", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "5475563d6bdb051fa7e099ffb3f588da02297310"}}, {"oid": "95a3fa8860dacec5cce32ed807408893df87d34e", "id": "add-files-to-index", "title": "add: Record added files in the index", "message": "<p>Right now, when we run <code>ugit commit</code>, all the changes in the working directory are written to the next commit. There are situations where this isn't very convenient. For example, we could have made multiple unrelated changes during the course of our work and we don't necessarily want to group them in the same commit.</p>\n<p>We will now implement a feature called <strong>the index</strong> which will allow finer grained control over commited files. It will allow us to specify which files in the working directory should be part of the commit and which shouldn't.</p>\n<p>The flow will look like this:</p>\n<ul>\n<li><p>The user modifies some files in the working directory.</p></li>\n<li><p>For each file that the user wishes to commit, he will run <code>ugit add path/to/file</code>. ugit will put the file into the object database and remember its OID in <strong>the index</strong>. The index is a dictionary that maps filenames to their last remembered OID. The index will be saved as a JSON file in the <em>.ugit</em> directory so that we can persist it between invocations of ugit.</p></li>\n<li><p>The user runs <code>ugit commit</code>, at which point <code>write-tree</code> will take the contents of <strong>the index</strong> and write it to a tree object. Since the index maps file names to OIDs, just like a tree object, the conversion will be easy.</p></li>\n</ul>\n<p>Previosuly, <code>write-tree</code> would take its data from the working directory. Now it will take the data from the index, and there would be a separate <code>add</code> command to put data into the index. This effectively allows the user to control what goes into the next commit by adding (\"staging\" in Git's lingo) the relevant files to the index.</p>\n<p>In this change we're going to lay out the foundations for the index. We will add a brand new <code>add</code> command to the CLI, then we will add a function called <code>get_index</code> that can read and write the index in JSON format, and then once <code>add</code> is invoked on a file it will record the current state of the file in the index.</p>\n<p>Note that this change doesn't affect ugit yet in any way, since <code>write-tree</code> still takes files from the working directory. We will connect <code>write-tree</code> to the index in a following change. For now you can run <code>ugit add</code> on a bunch of files and make sure that they indeed appear in <em>.ugit/index</em>.</p>\n<p>(BTW, real Git has a more complex and optimized data structure for the index, but JSON will be enough for us to get the idea.)</p>\n", "diff": {"ugit/base.py": {"changed_lines": [296, 297, 298, 299, 300, 301, 302, 303, 304, 305], "hunks": [{"title": "@@ -293,5 +293,15 @@ def get_oid (name):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"293\"><span class=\"d-s\">  </span>    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"294\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"295\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"296\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">filenames</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"297\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"298\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"299\"><span class=\"d-s\">+ </span>            <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line d-a\" data-line=\"300\"><span class=\"d-s\">+ </span>            <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"301\"><span class=\"d-s\">+ </span>            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"302\"><span class=\"d-s\">+ </span>                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line d-a\" data-line=\"303\"><span class=\"d-s\">+ </span>            <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"304\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"305\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"306\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"307\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [103, 104, 105, 106, 258, 259, 260, 261], "hunks": [{"title": "@@ -100,6 +100,10 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"101\"><span class=\"d-s\">  </span>    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span>    <span class=\"n\">add_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;add&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"104\"><span class=\"d-s\">+ </span>    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">add</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"105\"><span class=\"d-s\">+ </span>    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;files&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;+&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"106\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"107\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -251,3 +255,7 @@ def fetch (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"255\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"256\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"257\"><span class=\"d-s\">  </span>    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"258\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"259\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"260\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"261\"><span class=\"d-s\">+ </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">files</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [2, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97], "hunks": [{"title": "@@ -1,4 +1,5 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line d-a\" data-line=\"2\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">json</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">shutil</span>\n</span></code></pre></div>\n"}, {"title": "@@ -81,6 +82,19 @@ def iter_refs (prefix='', deref=True):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"82\"><span class=\"d-s\">  </span>            <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span>\n</span><span class=\"line\" data-line=\"83\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"84\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"85\"><span class=\"d-s\">+ </span><span class=\"nd\">@contextmanager</span>\n</span><span class=\"line d-a\" data-line=\"86\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_index</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"87\"><span class=\"d-s\">+ </span>    <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line d-a\" data-line=\"88\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/index&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"89\"><span class=\"d-s\">+ </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/index&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"90\"><span class=\"d-s\">+ </span>            <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">load</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"91\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"92\"><span class=\"d-s\">+ </span>    <span class=\"k\">yield</span> <span class=\"n\">index</span>\n</span><span class=\"line d-a\" data-line=\"93\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"94\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/index&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"95\"><span class=\"d-s\">+ </span>        <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dump</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"96\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"97\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "0fa8ed93e5141b22b0cebc04bc9aeaa0f9027eec", "ugit/cli.py": "f326aaf037e5a31431ea938f1d9b3856483743f5", "ugit/data.py": "9ad23fc186572f60791b893b511dc21131c3d630", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "5475563d6bdb051fa7e099ffb3f588da02297310"}}, {"oid": "29103d76f300e57a95a1e583d6594cf0cad5b7b9", "id": "add-entire-directory", "title": "add: Allow adding a directory", "message": "<p>Just to make using the index more convenient, we will also accept directory names in <code>ugit add</code>. This doesn't change anything conceptually, but makes the life easier for the user. In particular, we can even do <code>ugit add .</code> to add everything in the working directory.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313, 315, 316, 317, 318, 319], "hunks": [{"title": "@@ -294,13 +294,29 @@ def get_oid (name):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"294\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"295\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"296\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">filenames</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"297\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"298\"><span class=\"d-s\">+ </span>    <span class=\"k\">def</span> <span class=\"nf\">add_file</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"299\"><span class=\"d-s\">+ </span>        <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line d-a\" data-line=\"300\"><span class=\"d-s\">+ </span>        <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"301\"><span class=\"d-s\">+ </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"302\"><span class=\"d-s\">+ </span>            <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line d-a\" data-line=\"303\"><span class=\"d-s\">+ </span>        <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"304\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"305\"><span class=\"d-s\">+ </span>    <span class=\"k\">def</span> <span class=\"nf\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"306\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"307\"><span class=\"d-s\">+ </span>            <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"308\"><span class=\"d-s\">+ </span>                <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line d-a\" data-line=\"309\"><span class=\"d-s\">+ </span>                <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"310\"><span class=\"d-s\">+ </span>                <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"311\"><span class=\"d-s\">+ </span>                    <span class=\"k\">continue</span>\n</span><span class=\"line d-a\" data-line=\"312\"><span class=\"d-s\">+ </span>                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"313\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"314\"><span class=\"d-s\">  </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"315\"><span class=\"d-s\">- </span>        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"315\"><span class=\"d-s\">- </span>            <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line d-r\" data-line=\"315\"><span class=\"d-s\">- </span>            <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"315\"><span class=\"d-s\">- </span>            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"315\"><span class=\"d-s\">- </span>                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line d-r\" data-line=\"315\"><span class=\"d-s\">- </span>            <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"315\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"316\"><span class=\"d-s\">+ </span>            <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"317\"><span class=\"d-s\">+ </span>                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"318\"><span class=\"d-s\">+ </span>            <span class=\"k\">elif</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"319\"><span class=\"d-s\">+ </span>                <span class=\"n\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"320\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"321\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"322\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "732c0a1c8275a3683161ca0791b01db4f3ded586", "ugit/cli.py": "f326aaf037e5a31431ea938f1d9b3856483743f5", "ugit/data.py": "9ad23fc186572f60791b893b511dc21131c3d630", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "5475563d6bdb051fa7e099ffb3f588da02297310"}}, {"oid": "438130c112b0905a58024649b8dee64d10cd547f", "id": "write-tree-from-index", "title": "write-tree: Write from the index instead of the working directory", "message": "<p>Previously, <code>write_tree()</code> would scan the directory recursively, writing tree objects for each directory it encounters. Now it will take its data from the index. For this we will need to completely rewrite <code>write_tree()</code>.</p>\n<p>First, we need the convert the index, which is a flat list of files, to a tree of dictionaries. The index is stored as a flat list to make adding and removing items easier and to make it compatible with our diff logic in <em>diff.py</em> (as we will see later). However ugit stores the full tree in a hierarchy of tree objects, so we need the data as a tree of dictionaries.</p>\n<p>Then we will call <code>write_tree_recursive()</code> which is basically the same as the old <code>write_tree()</code>, but instead of operating on the filesystem it will work with the tree of dicts and write them to the objects store.</p>\n<p>Cool! Now the index kind of works. From now on you must remember to <code>add</code> files before committing them or else they won't be part of the commit.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 47], "hunks": [{"title": "@@ -14,27 +14,37 @@ def init ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"14\"><span class=\"d-s\">  </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"16\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>                <span class=\"k\">continue</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line d-r\" data-line=\"17\"><span class=\"d-s\">- </span>            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"17\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"18\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Index is flat, we need it as a tree of dicts</span>\n</span><span class=\"line d-a\" data-line=\"19\"><span class=\"d-s\">+ </span>    <span class=\"n\">index_as_tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line d-a\" data-line=\"20\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"21\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"22\"><span class=\"d-s\">+ </span>            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"23\"><span class=\"d-s\">+ </span>            <span class=\"n\">dirpath</span><span class=\"p\">,</span> <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">path</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line d-a\" data-line=\"24\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"25\"><span class=\"d-s\">+ </span>            <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">index_as_tree</span>\n</span><span class=\"line d-a\" data-line=\"26\"><span class=\"d-s\">+ </span>            <span class=\"c1\"># Find the dict for the directory of this file</span>\n</span><span class=\"line d-a\" data-line=\"27\"><span class=\"d-s\">+ </span>            <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirpath</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"28\"><span class=\"d-s\">+ </span>                <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">current</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">,</span> <span class=\"p\">{})</span>\n</span><span class=\"line d-a\" data-line=\"29\"><span class=\"d-s\">+ </span>            <span class=\"n\">current</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"30\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"31\"><span class=\"d-s\">+ </span>    <span class=\"k\">def</span> <span class=\"nf\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">tree_dict</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"32\"><span class=\"d-s\">+ </span>        <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line d-a\" data-line=\"33\"><span class=\"d-s\">+ </span>        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">tree_dict</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"34\"><span class=\"d-s\">+ </span>            <span class=\"k\">if</span> <span class=\"nb\">type</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"nb\">dict</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\"><span class=\"d-s\">  </span>                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line d-r\" data-line=\"36\"><span class=\"d-s\">- </span>                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"36\"><span class=\"d-s\">- </span>            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"36\"><span class=\"d-s\">+ </span>                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"37\"><span class=\"d-s\">+ </span>            <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"38\"><span class=\"d-s\">+ </span>                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line d-a\" data-line=\"39\"><span class=\"d-s\">+ </span>                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line d-a\" data-line=\"40\"><span class=\"d-s\">+ </span>            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"41\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"42\"><span class=\"d-s\">+ </span>        <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"43\"><span class=\"d-s\">+ </span>                        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line d-a\" data-line=\"44\"><span class=\"d-s\">+ </span>                        <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"45\"><span class=\"d-s\">+ </span>        <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"47\"><span class=\"d-s\">- </span>    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-r\" data-line=\"47\"><span class=\"d-s\">- </span>                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line d-r\" data-line=\"47\"><span class=\"d-s\">- </span>                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line d-r\" data-line=\"47\"><span class=\"d-s\">- </span>    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"47\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">index_as_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"49\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"50\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "8db6cc7a1c1fbb5d51bb7be9c8c78cc2a53443c6", "ugit/cli.py": "f326aaf037e5a31431ea938f1d9b3856483743f5", "ugit/data.py": "9ad23fc186572f60791b893b511dc21131c3d630", "ugit/diff.py": "9c6fbcf4088724b6a5d917f550a4a39c33218275", "ugit/remote.py": "5475563d6bdb051fa7e099ffb3f588da02297310"}}, {"oid": "4a7de24aa37b71598f73044b6f4886cefa369eed", "id": "read-tree-to-index", "title": "read-tree: Read into index instead of working directory", "message": "<p>For symmetry, we need to populate the index when reading a tree as well.</p>\n<p>During commit, the data flows from the working directory to the index to the commit, so when reading a tree (during checkout or merge) the data will flow from the tree to the index to the working directory.</p>\n<p>Without this change, when the user will checkout a different commit the state of the index will still reflect the files as they were during the old commit. But now it will be correctly updated.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 127, 129, 130, 132, 159, 181, 191], "hunks": [{"title": "@@ -102,21 +102,34 @@ def _empty_current_directory ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"102\"><span class=\"d-s\">  </span>                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"103\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"104\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"105\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"105\"><span class=\"d-s\">- </span>    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line d-r\" data-line=\"105\"><span class=\"d-s\">- </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-r\" data-line=\"105\"><span class=\"d-s\">- </span>        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"105\"><span class=\"d-s\">- </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"105\"><span class=\"d-s\">- </span>            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"105\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"106\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"107\"><span class=\"d-s\">+ </span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">clear</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"108\"><span class=\"d-s\">+ </span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"109\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"110\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">update_working</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"111\"><span class=\"d-s\">+ </span>            <span class=\"n\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"112\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"113\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"114\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"115\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"116\"><span class=\"d-s\">+ </span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">clear</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"117\"><span class=\"d-s\">+ </span>        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line d-a\" data-line=\"118\"><span class=\"d-s\">+ </span>            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span>\n</span><span class=\"line d-a\" data-line=\"119\"><span class=\"d-s\">+ </span>            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span>\n</span><span class=\"line d-a\" data-line=\"120\"><span class=\"d-s\">+ </span>            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"121\"><span class=\"d-s\">+ </span>        <span class=\"p\">))</span>\n</span><span class=\"line d-a\" data-line=\"122\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"123\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">update_working</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"124\"><span class=\"d-s\">+ </span>            <span class=\"n\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"126\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"127\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"127\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"128\"><span class=\"d-s\">  </span>    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line d-r\" data-line=\"129\"><span class=\"d-s\">- </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line d-r\" data-line=\"129\"><span class=\"d-s\">- </span>            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-r\" data-line=\"129\"><span class=\"d-s\">- </span>        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"129\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"130\"><span class=\"d-s\">+ </span>        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"131\"><span class=\"d-s\">  </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"132\"><span class=\"d-s\">- </span>            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"132\"><span class=\"d-s\">+ </span>            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"133\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"134\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"135\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}, {"title": "@@ -143,7 +156,7 @@ def commit (message):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"156\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"157\"><span class=\"d-s\">  </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"158\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"159\"><span class=\"d-s\">- </span>    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"159\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"160\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"161\"><span class=\"d-s\">  </span>    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"162\"><span class=\"d-s\">  </span>        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -165,7 +178,7 @@ def merge (other):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"178\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"179\"><span class=\"d-s\">  </span>    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"180\"><span class=\"d-s\">  </span>    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"181\"><span class=\"d-s\">- </span>        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"181\"><span class=\"d-s\">+ </span>        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"182\"><span class=\"d-s\">  </span>        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"183\"><span class=\"d-s\">  </span>                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"184\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -175,7 +188,7 @@ def merge (other):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"188\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"189\"><span class=\"d-s\">  </span>    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"190\"><span class=\"d-s\">  </span>    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"191\"><span class=\"d-s\">- </span>    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"191\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"192\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"193\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}, "ugit/diff.py": {"changed_lines": [56], "hunks": [{"title": "@@ -53,7 +53,7 @@ def diff_blobs (o_from, o_to, path='blob'):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"53\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"54\"><span class=\"d-s\">  </span>    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"55\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"56\"><span class=\"d-s\">- </span>        <span class=\"n\">tree</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"56\"><span class=\"d-s\">+ </span>        <span class=\"n\">tree</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"58\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "881aa7b7b34adb1519999f7eefc160365edb53e6", "ugit/cli.py": "f326aaf037e5a31431ea938f1d9b3856483743f5", "ugit/data.py": "9ad23fc186572f60791b893b511dc21131c3d630", "ugit/diff.py": "853cc2f82fa79cbdfb092aed004823048cee2779", "ugit/remote.py": "5475563d6bdb051fa7e099ffb3f588da02297310"}}, {"oid": "f99dbd0b1060e6db5da25e181af12deba7633875", "id": "status-show-staged", "title": "status: Show staged and non-staged modified files", "message": "<p>To make user's life easier, let's extend the <code>status</code> command to display which changed files will be committed and which files were changed but not going to be committed.</p>\n<p>The change is quite simple because it relies on existing infrastructure. To display changed files that <strong>are</strong> going to be committed, we will compare index to HEAD. To display changed files that <strong>aren't</strong> going to be committed we will compare the index to the working tree.</p>\n<p>Note that a file can be present in both groups - maybe we changed it, added it to the index, changed it some more but didn't add the latest changes to the index.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [86, 87, 88, 89, 90], "hunks": [{"title": "@@ -83,6 +83,11 @@ def get_working_tree ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"83\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"84\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"85\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"86\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_index_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"87\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"88\"><span class=\"d-s\">+ </span>        <span class=\"k\">return</span> <span class=\"n\">index</span>\n</span><span class=\"line d-a\" data-line=\"89\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"90\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"91\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"92\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\"><span class=\"d-s\">  </span>        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [236, 237, 238, 239, 240], "hunks": [{"title": "@@ -233,6 +233,11 @@ def status (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"233\"><span class=\"d-s\">  </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"234\"><span class=\"d-s\">  </span>    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"235\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line d-a\" data-line=\"236\"><span class=\"d-s\">+ </span>                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line d-a\" data-line=\"237\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"238\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"239\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes not staged for commit:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"240\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">(),</span>\n</span><span class=\"line\" data-line=\"241\"><span class=\"d-s\">  </span>                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"242\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "c9a0a111473ac49b6956fc6dc6f472eed8e34790", "ugit/cli.py": "fcf0e98217fa0a8323a2a28edd19e8d14805f95a", "ugit/data.py": "9ad23fc186572f60791b893b511dc21131c3d630", "ugit/diff.py": "853cc2f82fa79cbdfb092aed004823048cee2779", "ugit/remote.py": "5475563d6bdb051fa7e099ffb3f588da02297310"}}, {"oid": "94ef8ae23381cc5c1e29df9f1002c2323b5ddde6", "id": "diff-use-index", "title": "diff: Add --cached option and take index into account", "message": "<p>Let's add another mode to <code>ugit diff</code>. Previously the command would diff the working tree and another commit. Now that we have the index, let's introduce a few more useful modes to <code>diff</code>:</p>\n<ul>\n<li><p>If no arguments are provided, diff from the index to the working directory. This way you can quickly see unstaged changes.</p></li>\n<li><p>If <code>--cached</code> was provided, diff from HEAD to the index. This way you can quickly see which changes are going to be commited.</p></li>\n<li><p>If a specific commit was provided, diff from the commit to the index or working directory (depending on whether --cached was provided).</p></li>\n</ul>\n<p>Unfortunately <code>--cached</code> is an obscure name for a flag, but that's what real Git uses so we're going to stick to conventions.</p>\n", "diff": {"ugit/cli.py": {"changed_lines": [59, 60, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 189], "hunks": [{"title": "@@ -56,7 +56,8 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\"><span class=\"d-s\">  </span>    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"59\"><span class=\"d-s\">- </span>    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"59\"><span class=\"d-s\">+ </span>    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;--cached&#39;</span><span class=\"p\">,</span> <span class=\"n\">action</span><span class=\"o\">=</span><span class=\"s1\">&#39;store_true&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"60\"><span class=\"d-s\">+ </span>    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"62\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -167,9 +168,25 @@ def show (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"168\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"169\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"170\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"171\"><span class=\"d-s\">- </span>    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line d-a\" data-line=\"171\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"172\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"173\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"174\"><span class=\"d-s\">+ </span>        <span class=\"c1\"># If a commit was provided explicitly, diff from it</span>\n</span><span class=\"line d-a\" data-line=\"175\"><span class=\"d-s\">+ </span>        <span class=\"n\">tree_from</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"176\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"177\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">cached</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"178\"><span class=\"d-s\">+ </span>        <span class=\"n\">tree_to</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"179\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"180\"><span class=\"d-s\">+ </span>            <span class=\"c1\"># If no commit was provided, diff from HEAD</span>\n</span><span class=\"line d-a\" data-line=\"181\"><span class=\"d-s\">+ </span>            <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"182\"><span class=\"d-s\">+ </span>            <span class=\"n\">tree_from</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"183\"><span class=\"d-s\">+ </span>    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"184\"><span class=\"d-s\">+ </span>        <span class=\"n\">tree_to</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"185\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"186\"><span class=\"d-s\">+ </span>            <span class=\"c1\"># If no commit was provided, diff from index</span>\n</span><span class=\"line d-a\" data-line=\"187\"><span class=\"d-s\">+ </span>            <span class=\"n\">tree_from</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"188\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"189\"><span class=\"d-s\">- </span>    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line d-a\" data-line=\"189\"><span class=\"d-s\">+ </span>    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">tree_from</span><span class=\"p\">,</span> <span class=\"n\">tree_to</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"190\"><span class=\"d-s\">  </span>    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"191\"><span class=\"d-s\">  </span>    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "c9a0a111473ac49b6956fc6dc6f472eed8e34790", "ugit/cli.py": "219bd158302acc07fe9f9e41c974234009bb97eb", "ugit/data.py": "9ad23fc186572f60791b893b511dc21131c3d630", "ugit/diff.py": "853cc2f82fa79cbdfb092aed004823048cee2779", "ugit/remote.py": "5475563d6bdb051fa7e099ffb3f588da02297310"}}], "objects": {"02de9f118bd0a4619677475b6e2a7c5b166881dc": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">remote</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">fetch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">fetch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"n\">push_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;push&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">push</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"107\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"113\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">\n</span><span class=\"line\" data-line=\"116\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"117\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"119\">\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"122\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"123\">\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"130\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"137\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"138\">\n</span><span class=\"line\" data-line=\"139\">\n</span><span class=\"line\" data-line=\"140\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"141\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"142\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"143\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"146\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"147\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"152\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"155\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"156\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"157\">\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"160\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"161\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"162\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">\n</span><span class=\"line\" data-line=\"165\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"167\">\n</span><span class=\"line\" data-line=\"168\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"169\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"170\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\">\n</span><span class=\"line\" data-line=\"173\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"174\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\">\n</span><span class=\"line\" data-line=\"177\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"178\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\">\n</span><span class=\"line\" data-line=\"181\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"182\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"183\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"184\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"185\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"186\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"187\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"188\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"189\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"190\">\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"193\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"194\">\n</span><span class=\"line\" data-line=\"195\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"196\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"197\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"198\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"199\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"200\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"201\">\n</span><span class=\"line\" data-line=\"202\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"203\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"205\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"206\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"207\">\n</span><span class=\"line\" data-line=\"208\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"209\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"210\">\n</span><span class=\"line\" data-line=\"211\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"212\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"213\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"214\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"215\">\n</span><span class=\"line\" data-line=\"216\">\n</span><span class=\"line\" data-line=\"217\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"218\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"219\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"220\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"222\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"223\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"224\">\n</span><span class=\"line\" data-line=\"225\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"226\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"227\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"231\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"232\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"233\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"234\">\n</span><span class=\"line\" data-line=\"235\">\n</span><span class=\"line\" data-line=\"236\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"237\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"238\">\n</span><span class=\"line\" data-line=\"239\">\n</span><span class=\"line\" data-line=\"240\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"241\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"242\">\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\"><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"245\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"246\">\n</span><span class=\"line\" data-line=\"247\">\n</span><span class=\"line\" data-line=\"248\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"249\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"250\">\n</span><span class=\"line\" data-line=\"251\">\n</span><span class=\"line\" data-line=\"252\"><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"253\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "5567162fbf21d98373ad15a9218aa4532d5481e8": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">shutil</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"c1\"># Will be initialized in cli.main()</span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"nd\">@contextmanager</span>\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">new_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"k\">global</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">old_dir</span> <span class=\"o\">=</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">new_dir</span><span class=\"si\">}</span><span class=\"s1\">/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"k\">yield</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"n\">old_dir</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\"><span class=\"n\">RefValue</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;RefValue&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;symbolic&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;value&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">assert</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;ref: </span><span class=\"si\">{</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"37\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">delete_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">\n</span><span class=\"line\" data-line=\"54\"><span class=\"k\">def</span> <span class=\"nf\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"58\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"59\">            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">symbolic</span> <span class=\"o\">=</span> <span class=\"nb\">bool</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;ref:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">    <span class=\"k\">if</span> <span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"63\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;:&#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"k\">if</span> <span class=\"n\">deref</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"65\">            <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\">    <span class=\"k\">return</span> <span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"n\">symbolic</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\">\n</span><span class=\"line\" data-line=\"70\"><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"77\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">refname</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"n\">deref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"k\">if</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"81\">            <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"94\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">partition</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\"><span class=\"k\">def</span> <span class=\"nf\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\"><span class=\"k\">def</span> <span class=\"nf\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_git_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"k\">if</span> <span class=\"n\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"113\">                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">\n</span><span class=\"line\" data-line=\"116\"><span class=\"k\">def</span> <span class=\"nf\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_git_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"117\">    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"119\">                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">\n</span></code></pre></div>\n", "fd041ae10a8955417a42bd1c4ffc5ac826094aee": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"n\">REMOTE_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/heads/&#39;</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"n\">LOCAL_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/remote/&#39;</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"c1\"># Get refs from server</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\">    <span class=\"c1\"># Fetch missing objects by iterating and fetching on demand</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"17\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">    <span class=\"c1\"># Update local refs to match server</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">for</span> <span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"n\">refname</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">LOCAL_REFS_BASE</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"23\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\"><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">refname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"c1\"># Get refs data</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">local_ref</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"k\">assert</span> <span class=\"n\">local_ref</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">objects_to_push</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">({</span><span class=\"n\">local_ref</span><span class=\"p\">})</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"c1\"># Push all objects</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">objects_to_push</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">    <span class=\"c1\"># Update server ref to our value</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"40\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">local_ref</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\"><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n", "f99d3ae2456f14260ef39c78e32235d1b5674e4d": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"n\">REMOTE_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/heads/&#39;</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"n\">LOCAL_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/remote/&#39;</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"c1\"># Get refs from server</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\">    <span class=\"c1\"># Fetch missing objects by iterating and fetching on demand</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"17\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">    <span class=\"c1\"># Update local refs to match server</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">for</span> <span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"n\">refname</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">LOCAL_REFS_BASE</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"23\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\"><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">refname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"c1\"># Get refs data</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">remote_refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">local_ref</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">assert</span> <span class=\"n\">local_ref</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">    <span class=\"c1\"># Compute which objects the server doesn&#39;t have</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">known_remote_refs</span> <span class=\"o\">=</span> <span class=\"nb\">filter</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">object_exists</span><span class=\"p\">,</span> <span class=\"n\">remote_refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">remote_objects</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">known_remote_refs</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">local_objects</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">({</span><span class=\"n\">local_ref</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">objects_to_push</span> <span class=\"o\">=</span> <span class=\"n\">local_objects</span> <span class=\"o\">-</span> <span class=\"n\">remote_objects</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"c1\"># Push missing objects</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">objects_to_push</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">    <span class=\"c1\"># Update server ref to our value</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"45\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">local_ref</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\"><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n", "247354ccfe987568136b9c1bb485d262c8924ad5": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"106\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"109\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"158\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"160\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"161\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"162\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"176\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"177\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\"><span class=\"k\">def</span> <span class=\"nf\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">maybe_ancestor</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"181\">    <span class=\"k\">return</span> <span class=\"n\">maybe_ancestor</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">commit</span><span class=\"p\">})</span>\n</span><span class=\"line\" data-line=\"182\">\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"185\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\">\n</span><span class=\"line\" data-line=\"188\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"189\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"190\">\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"193\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"194\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"195\">\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"198\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"199\">\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"205\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"207\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">\n</span><span class=\"line\" data-line=\"209\">\n</span><span class=\"line\" data-line=\"210\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">\n</span><span class=\"line\" data-line=\"213\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"215\">\n</span><span class=\"line\" data-line=\"216\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"218\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"219\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"220\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"223\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"224\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"225\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"226\">\n</span><span class=\"line\" data-line=\"227\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"229\">\n</span><span class=\"line\" data-line=\"230\">\n</span><span class=\"line\" data-line=\"231\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"232\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"233\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"234\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"238\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"239\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"240\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"241\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"245\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"246\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"247\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"248\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"249\">\n</span><span class=\"line\" data-line=\"250\">\n</span><span class=\"line\" data-line=\"251\"><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"252\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"253\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"254\">\n</span><span class=\"line\" data-line=\"255\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"256\">    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"257\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"258\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"259\">        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"260\">            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"261\">                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"262\">                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"263\">                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"264\">                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"265\">                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"266\">\n</span><span class=\"line\" data-line=\"267\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"268\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"269\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"270\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"271\">            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"272\">\n</span><span class=\"line\" data-line=\"273\">\n</span><span class=\"line\" data-line=\"274\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"275\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"276\">\n</span><span class=\"line\" data-line=\"277\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"278\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"279\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"280\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"281\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"282\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"283\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"284\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"285\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"286\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"287\">\n</span><span class=\"line\" data-line=\"288\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"289\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"290\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"291\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"292\">\n</span><span class=\"line\" data-line=\"293\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"294\">\n</span><span class=\"line\" data-line=\"295\">\n</span><span class=\"line\" data-line=\"296\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"297\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "5475563d6bdb051fa7e099ffb3f588da02297310": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"n\">REMOTE_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/heads/&#39;</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"n\">LOCAL_REFS_BASE</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;refs/remote/&#39;</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"c1\"># Get refs from server</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\">    <span class=\"c1\"># Fetch missing objects by iterating and fetching on demand</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"17\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">    <span class=\"c1\"># Update local refs to match server</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">for</span> <span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"n\">refname</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">remote_name</span><span class=\"p\">,</span> <span class=\"n\">REMOTE_REFS_BASE</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">LOCAL_REFS_BASE</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"23\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\"><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">refname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"c1\"># Get refs data</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">remote_refs</span> <span class=\"o\">=</span> <span class=\"n\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">remote_ref</span> <span class=\"o\">=</span> <span class=\"n\">remote_refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">local_ref</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">assert</span> <span class=\"n\">local_ref</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"c1\"># Don&#39;t allow force push</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">assert</span> <span class=\"ow\">not</span> <span class=\"n\">remote_ref</span> <span class=\"ow\">or</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">local_ref</span><span class=\"p\">,</span> <span class=\"n\">remote_ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"c1\"># Compute which objects the server doesn&#39;t have</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">known_remote_refs</span> <span class=\"o\">=</span> <span class=\"nb\">filter</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">object_exists</span><span class=\"p\">,</span> <span class=\"n\">remote_refs</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">remote_objects</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">known_remote_refs</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">local_objects</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_objects_in_commits</span> <span class=\"p\">({</span><span class=\"n\">local_ref</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">objects_to_push</span> <span class=\"o\">=</span> <span class=\"n\">local_objects</span> <span class=\"o\">-</span> <span class=\"n\">remote_objects</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">    <span class=\"c1\"># Push missing objects</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">objects_to_push</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">\n</span><span class=\"line\" data-line=\"46\">    <span class=\"c1\"># Update server ref to our value</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"49\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">local_ref</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"50\">\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\"><span class=\"k\">def</span> <span class=\"nf\">_get_remote_refs</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">remote_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">refname</span><span class=\"p\">:</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)}</span>\n</span></code></pre></div>\n", "0fa8ed93e5141b22b0cebc04bc9aeaa0f9027eec": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"106\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"109\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"158\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"160\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"161\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"162\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"176\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"177\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\"><span class=\"k\">def</span> <span class=\"nf\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">maybe_ancestor</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"181\">    <span class=\"k\">return</span> <span class=\"n\">maybe_ancestor</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">commit</span><span class=\"p\">})</span>\n</span><span class=\"line\" data-line=\"182\">\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"185\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\">\n</span><span class=\"line\" data-line=\"188\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"189\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"190\">\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"193\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"194\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"195\">\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"198\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"199\">\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"205\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"207\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">\n</span><span class=\"line\" data-line=\"209\">\n</span><span class=\"line\" data-line=\"210\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">\n</span><span class=\"line\" data-line=\"213\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"215\">\n</span><span class=\"line\" data-line=\"216\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"218\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"219\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"220\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"223\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"224\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"225\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"226\">\n</span><span class=\"line\" data-line=\"227\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"229\">\n</span><span class=\"line\" data-line=\"230\">\n</span><span class=\"line\" data-line=\"231\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"232\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"233\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"234\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"238\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"239\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"240\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"241\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"245\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"246\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"247\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"248\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"249\">\n</span><span class=\"line\" data-line=\"250\">\n</span><span class=\"line\" data-line=\"251\"><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"252\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"253\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"254\">\n</span><span class=\"line\" data-line=\"255\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"256\">    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"257\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"258\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"259\">        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"260\">            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"261\">                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"262\">                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"263\">                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"264\">                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"265\">                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"266\">\n</span><span class=\"line\" data-line=\"267\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"268\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"269\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"270\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"271\">            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"272\">\n</span><span class=\"line\" data-line=\"273\">\n</span><span class=\"line\" data-line=\"274\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"275\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"276\">\n</span><span class=\"line\" data-line=\"277\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"278\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"279\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"280\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"281\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"282\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"283\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"284\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"285\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"286\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"287\">\n</span><span class=\"line\" data-line=\"288\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"289\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"290\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"291\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"292\">\n</span><span class=\"line\" data-line=\"293\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"294\">\n</span><span class=\"line\" data-line=\"295\">\n</span><span class=\"line\" data-line=\"296\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">filenames</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"297\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"298\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"299\">            <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"300\">            <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"301\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"302\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"303\">            <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"304\">\n</span><span class=\"line\" data-line=\"305\">\n</span><span class=\"line\" data-line=\"306\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"307\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "f326aaf037e5a31431ea938f1d9b3856483743f5": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">remote</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">fetch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">fetch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"n\">push_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;push&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">push</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">add_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;add&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">add</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;files&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;+&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">\n</span><span class=\"line\" data-line=\"120\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"121\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"122\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"123\">\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"130\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"135\">\n</span><span class=\"line\" data-line=\"136\">\n</span><span class=\"line\" data-line=\"137\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"138\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"141\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">\n</span><span class=\"line\" data-line=\"144\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"145\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"147\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"150\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"151\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"152\">\n</span><span class=\"line\" data-line=\"153\">\n</span><span class=\"line\" data-line=\"154\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"155\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"156\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"160\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"161\">\n</span><span class=\"line\" data-line=\"162\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"163\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"164\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">\n</span><span class=\"line\" data-line=\"168\">\n</span><span class=\"line\" data-line=\"169\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"170\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"174\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\">\n</span><span class=\"line\" data-line=\"177\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"178\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\">\n</span><span class=\"line\" data-line=\"181\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"182\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\">\n</span><span class=\"line\" data-line=\"185\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"186\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"187\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"188\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"189\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"190\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"192\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"193\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"194\">\n</span><span class=\"line\" data-line=\"195\">\n</span><span class=\"line\" data-line=\"196\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"197\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"198\">\n</span><span class=\"line\" data-line=\"199\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"200\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"201\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"202\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"203\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"204\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"207\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"209\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"210\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"214\">\n</span><span class=\"line\" data-line=\"215\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"216\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"217\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"218\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\">\n</span><span class=\"line\" data-line=\"221\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"222\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"223\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"224\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"225\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"226\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"227\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"231\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"232\">\n</span><span class=\"line\" data-line=\"233\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"234\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"236\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"237\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"238\">\n</span><span class=\"line\" data-line=\"239\">\n</span><span class=\"line\" data-line=\"240\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"241\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"242\">\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"245\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"246\">\n</span><span class=\"line\" data-line=\"247\">\n</span><span class=\"line\" data-line=\"248\"><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"249\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"250\">\n</span><span class=\"line\" data-line=\"251\">\n</span><span class=\"line\" data-line=\"252\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"253\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"254\">\n</span><span class=\"line\" data-line=\"255\">\n</span><span class=\"line\" data-line=\"256\"><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"257\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"258\">\n</span><span class=\"line\" data-line=\"259\">\n</span><span class=\"line\" data-line=\"260\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"261\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">files</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "9ad23fc186572f60791b893b511dc21131c3d630": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">json</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">shutil</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"c1\"># Will be initialized in cli.main()</span>\n</span><span class=\"line\" data-line=\"11\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"nd\">@contextmanager</span>\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">change_git_dir</span> <span class=\"p\">(</span><span class=\"n\">new_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">global</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">old_dir</span> <span class=\"o\">=</span> <span class=\"n\">GIT_DIR</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">new_dir</span><span class=\"si\">}</span><span class=\"s1\">/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">yield</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"n\">old_dir</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\"><span class=\"n\">RefValue</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;RefValue&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;symbolic&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;value&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">assert</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"36\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;ref: </span><span class=\"si\">{</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"43\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">\n</span><span class=\"line\" data-line=\"46\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\"><span class=\"k\">def</span> <span class=\"nf\">delete_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">\n</span><span class=\"line\" data-line=\"54\">\n</span><span class=\"line\" data-line=\"55\"><span class=\"k\">def</span> <span class=\"nf\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"61\">\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">symbolic</span> <span class=\"o\">=</span> <span class=\"nb\">bool</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;ref:&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\">    <span class=\"k\">if</span> <span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;:&#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"65\">        <span class=\"k\">if</span> <span class=\"n\">deref</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"k\">return</span> <span class=\"n\">_get_ref_internal</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">    <span class=\"k\">return</span> <span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"n\">symbolic</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\"><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"74\">        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">refname</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"n\">ref</span> <span class=\"o\">=</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"n\">deref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"81\">        <span class=\"k\">if</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span>\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\"><span class=\"nd\">@contextmanager</span>\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">get_index</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/index&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"89\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/index&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"90\">            <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">load</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\">    <span class=\"k\">yield</span> <span class=\"n\">index</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/index&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"95\">        <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dump</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">,</span> <span class=\"n\">f</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"100\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"102\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"107\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">    <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">partition</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"112\">\n</span><span class=\"line\" data-line=\"113\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"114\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"115\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span><span class=\"line\" data-line=\"116\">\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\"><span class=\"k\">def</span> <span class=\"nf\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\"><span class=\"k\">def</span> <span class=\"nf\">fetch_object_if_missing</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_git_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"k\">if</span> <span class=\"n\">object_exists</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"124\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"127\">                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\"><span class=\"k\">def</span> <span class=\"nf\">push_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">remote_git_dir</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"131\">    <span class=\"n\">remote_git_dir</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;/.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"132\">    <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">copy</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"133\">                 <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">remote_git_dir</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"134\">\n</span></code></pre></div>\n", "732c0a1c8275a3683161ca0791b01db4f3ded586": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"26\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"27\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"31\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"35\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"36\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"42\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"56\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"57\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"58\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"82\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"84\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"87\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"92\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"106\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"109\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"141\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"158\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"160\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"161\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"162\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"174\">\n</span><span class=\"line\" data-line=\"175\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"176\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"177\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\"><span class=\"k\">def</span> <span class=\"nf\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">maybe_ancestor</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"181\">    <span class=\"k\">return</span> <span class=\"n\">maybe_ancestor</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">commit</span><span class=\"p\">})</span>\n</span><span class=\"line\" data-line=\"182\">\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"185\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\">\n</span><span class=\"line\" data-line=\"188\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"189\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"190\">\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"193\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"194\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"195\">\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"198\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"199\">\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"202\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"205\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"207\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">\n</span><span class=\"line\" data-line=\"209\">\n</span><span class=\"line\" data-line=\"210\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">\n</span><span class=\"line\" data-line=\"213\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"215\">\n</span><span class=\"line\" data-line=\"216\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"218\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"219\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"220\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"223\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"224\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"225\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"226\">\n</span><span class=\"line\" data-line=\"227\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"229\">\n</span><span class=\"line\" data-line=\"230\">\n</span><span class=\"line\" data-line=\"231\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"232\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"233\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"234\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"238\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"239\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"240\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"241\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"245\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"246\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"247\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"248\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"249\">\n</span><span class=\"line\" data-line=\"250\">\n</span><span class=\"line\" data-line=\"251\"><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"252\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"253\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"254\">\n</span><span class=\"line\" data-line=\"255\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"256\">    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"257\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"258\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"259\">        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"260\">            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"261\">                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"262\">                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"263\">                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"264\">                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"265\">                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"266\">\n</span><span class=\"line\" data-line=\"267\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"268\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"269\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"270\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"271\">            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"272\">\n</span><span class=\"line\" data-line=\"273\">\n</span><span class=\"line\" data-line=\"274\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"275\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"276\">\n</span><span class=\"line\" data-line=\"277\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"278\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"279\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"280\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"281\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"282\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"283\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"284\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"285\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"286\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"287\">\n</span><span class=\"line\" data-line=\"288\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"289\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"290\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"291\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"292\">\n</span><span class=\"line\" data-line=\"293\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"294\">\n</span><span class=\"line\" data-line=\"295\">\n</span><span class=\"line\" data-line=\"296\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">filenames</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"297\">\n</span><span class=\"line\" data-line=\"298\">    <span class=\"k\">def</span> <span class=\"nf\">add_file</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"299\">        <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"300\">        <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"301\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"302\">            <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"303\">        <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"304\">\n</span><span class=\"line\" data-line=\"305\">    <span class=\"k\">def</span> <span class=\"nf\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"306\">        <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"307\">            <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"308\">                <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"309\">                <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"310\">                <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"311\">                    <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"312\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"313\">\n</span><span class=\"line\" data-line=\"314\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"315\">        <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"316\">            <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"317\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"318\">            <span class=\"k\">elif</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"319\">                <span class=\"n\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"320\">\n</span><span class=\"line\" data-line=\"321\">\n</span><span class=\"line\" data-line=\"322\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"323\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "8db6cc7a1c1fbb5d51bb7be9c8c78cc2a53443c6": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"c1\"># Index is flat, we need it as a tree of dicts</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">index_as_tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"n\">dirpath</span><span class=\"p\">,</span> <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">path</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">index_as_tree</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"c1\"># Find the dict for the directory of this file</span>\n</span><span class=\"line\" data-line=\"27\">            <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirpath</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">current</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">,</span> <span class=\"p\">{})</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"n\">current</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">def</span> <span class=\"nf\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">tree_dict</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"32\">        <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"33\">        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">tree_dict</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">            <span class=\"k\">if</span> <span class=\"nb\">type</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"nb\">dict</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"36\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">            <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"38\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"39\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"40\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">        <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"43\">                        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"44\">                        <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"k\">return</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">index_as_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"63\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"65\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"78\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"80\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"81\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"82\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"88\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"92\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"94\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"97\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"98\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"100\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"101\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"102\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"107\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"109\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"110\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\">\n</span><span class=\"line\" data-line=\"113\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"114\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"115\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">blob</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"116\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">))</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"118\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"119\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">blob</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"127\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"129\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"130\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"131\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"135\">\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"139\">\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"144\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"145\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"147\">\n</span><span class=\"line\" data-line=\"148\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"149\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"150\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"151\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"152\">\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"158\">\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"161\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"162\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"163\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"168\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"169\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"170\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"171\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"172\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"173\">\n</span><span class=\"line\" data-line=\"174\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"177\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"178\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"179\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"180\">\n</span><span class=\"line\" data-line=\"181\">\n</span><span class=\"line\" data-line=\"182\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"183\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"184\">\n</span><span class=\"line\" data-line=\"185\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"186\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"187\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"188\">\n</span><span class=\"line\" data-line=\"189\">\n</span><span class=\"line\" data-line=\"190\"><span class=\"k\">def</span> <span class=\"nf\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">maybe_ancestor</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"k\">return</span> <span class=\"n\">maybe_ancestor</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">commit</span><span class=\"p\">})</span>\n</span><span class=\"line\" data-line=\"192\">\n</span><span class=\"line\" data-line=\"193\">\n</span><span class=\"line\" data-line=\"194\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"195\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\">\n</span><span class=\"line\" data-line=\"198\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"199\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\">\n</span><span class=\"line\" data-line=\"202\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\">\n</span><span class=\"line\" data-line=\"207\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"208\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"209\">\n</span><span class=\"line\" data-line=\"210\">\n</span><span class=\"line\" data-line=\"211\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"212\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"214\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"215\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"216\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"218\">\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"221\">\n</span><span class=\"line\" data-line=\"222\">\n</span><span class=\"line\" data-line=\"223\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"224\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"225\">\n</span><span class=\"line\" data-line=\"226\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"227\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"228\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"229\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"230\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"231\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"232\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"233\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"234\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"235\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"238\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"239\">\n</span><span class=\"line\" data-line=\"240\">\n</span><span class=\"line\" data-line=\"241\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"242\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"243\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"244\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"245\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"246\">\n</span><span class=\"line\" data-line=\"247\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"248\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"249\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"250\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"251\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"252\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"253\">\n</span><span class=\"line\" data-line=\"254\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"255\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"256\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"257\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"258\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"259\">\n</span><span class=\"line\" data-line=\"260\">\n</span><span class=\"line\" data-line=\"261\"><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"262\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"263\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"264\">\n</span><span class=\"line\" data-line=\"265\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"266\">    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"267\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"268\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"269\">        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"270\">            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"271\">                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"272\">                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"273\">                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"274\">                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"275\">                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"276\">\n</span><span class=\"line\" data-line=\"277\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"278\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"279\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"280\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"281\">            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"282\">\n</span><span class=\"line\" data-line=\"283\">\n</span><span class=\"line\" data-line=\"284\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"285\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"286\">\n</span><span class=\"line\" data-line=\"287\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"288\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"289\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"290\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"291\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"292\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"293\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"294\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"295\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"296\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"297\">\n</span><span class=\"line\" data-line=\"298\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"299\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"300\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"301\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"302\">\n</span><span class=\"line\" data-line=\"303\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"304\">\n</span><span class=\"line\" data-line=\"305\">\n</span><span class=\"line\" data-line=\"306\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">filenames</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"307\">\n</span><span class=\"line\" data-line=\"308\">    <span class=\"k\">def</span> <span class=\"nf\">add_file</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"309\">        <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"310\">        <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"311\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"312\">            <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"313\">        <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"314\">\n</span><span class=\"line\" data-line=\"315\">    <span class=\"k\">def</span> <span class=\"nf\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"316\">        <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"317\">            <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"318\">                <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"319\">                <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"320\">                <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"321\">                    <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"322\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"323\">\n</span><span class=\"line\" data-line=\"324\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"325\">        <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"326\">            <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"327\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"328\">            <span class=\"k\">elif</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"329\">                <span class=\"n\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"330\">\n</span><span class=\"line\" data-line=\"331\">\n</span><span class=\"line\" data-line=\"332\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"333\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "881aa7b7b34adb1519999f7eefc160365edb53e6": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"c1\"># Index is flat, we need it as a tree of dicts</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">index_as_tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"n\">dirpath</span><span class=\"p\">,</span> <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">path</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">index_as_tree</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"c1\"># Find the dict for the directory of this file</span>\n</span><span class=\"line\" data-line=\"27\">            <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirpath</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">current</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">,</span> <span class=\"p\">{})</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"n\">current</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">def</span> <span class=\"nf\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">tree_dict</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"32\">        <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"33\">        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">tree_dict</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">            <span class=\"k\">if</span> <span class=\"nb\">type</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"nb\">dict</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"36\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">            <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"38\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"39\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"40\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">        <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"43\">                        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"44\">                        <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"k\">return</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">index_as_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"63\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"65\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"78\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"80\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"81\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"82\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"88\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"91\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"92\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"94\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"97\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"98\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"100\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"101\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"102\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"107\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">clear</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">        <span class=\"k\">if</span> <span class=\"n\">update_working</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"111\">            <span class=\"n\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"112\">\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"115\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">clear</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"118\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"119\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"120\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">        <span class=\"k\">if</span> <span class=\"n\">update_working</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"124\">            <span class=\"n\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\"><span class=\"k\">def</span> <span class=\"nf\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"129\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"130\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"131\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"132\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"133\">\n</span><span class=\"line\" data-line=\"134\">\n</span><span class=\"line\" data-line=\"135\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"140\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"141\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"142\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"143\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"144\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"150\">\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"152\">\n</span><span class=\"line\" data-line=\"153\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"154\">\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"160\">\n</span><span class=\"line\" data-line=\"161\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"162\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"163\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"164\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">\n</span><span class=\"line\" data-line=\"168\">\n</span><span class=\"line\" data-line=\"169\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"170\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\">\n</span><span class=\"line\" data-line=\"173\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"174\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"175\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"176\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"177\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"178\">\n</span><span class=\"line\" data-line=\"179\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"180\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"181\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"182\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"183\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"184\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"185\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"186\">\n</span><span class=\"line\" data-line=\"187\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"188\">\n</span><span class=\"line\" data-line=\"189\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"190\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"192\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"193\">\n</span><span class=\"line\" data-line=\"194\">\n</span><span class=\"line\" data-line=\"195\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"196\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"197\">\n</span><span class=\"line\" data-line=\"198\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"199\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"200\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"201\">\n</span><span class=\"line\" data-line=\"202\">\n</span><span class=\"line\" data-line=\"203\"><span class=\"k\">def</span> <span class=\"nf\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">maybe_ancestor</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"204\">    <span class=\"k\">return</span> <span class=\"n\">maybe_ancestor</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">commit</span><span class=\"p\">})</span>\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\">\n</span><span class=\"line\" data-line=\"207\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"208\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"209\">\n</span><span class=\"line\" data-line=\"210\">\n</span><span class=\"line\" data-line=\"211\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"212\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"213\">\n</span><span class=\"line\" data-line=\"214\">\n</span><span class=\"line\" data-line=\"215\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"216\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"217\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"218\">\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"221\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"222\">\n</span><span class=\"line\" data-line=\"223\">\n</span><span class=\"line\" data-line=\"224\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"225\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"226\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"227\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"228\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"229\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"231\">\n</span><span class=\"line\" data-line=\"232\">\n</span><span class=\"line\" data-line=\"233\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"234\">\n</span><span class=\"line\" data-line=\"235\">\n</span><span class=\"line\" data-line=\"236\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"237\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"238\">\n</span><span class=\"line\" data-line=\"239\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"240\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"241\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"243\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"244\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"245\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"246\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"247\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"248\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"249\">\n</span><span class=\"line\" data-line=\"250\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"251\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"252\">\n</span><span class=\"line\" data-line=\"253\">\n</span><span class=\"line\" data-line=\"254\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"255\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"256\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"257\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"258\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"259\">\n</span><span class=\"line\" data-line=\"260\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"261\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"262\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"263\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"264\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"265\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"266\">\n</span><span class=\"line\" data-line=\"267\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"268\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"269\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"270\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"271\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"272\">\n</span><span class=\"line\" data-line=\"273\">\n</span><span class=\"line\" data-line=\"274\"><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"275\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"276\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"277\">\n</span><span class=\"line\" data-line=\"278\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"279\">    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"280\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"281\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"282\">        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"283\">            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"284\">                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"285\">                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"286\">                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"287\">                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"288\">                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"289\">\n</span><span class=\"line\" data-line=\"290\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"291\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"292\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"293\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"294\">            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"295\">\n</span><span class=\"line\" data-line=\"296\">\n</span><span class=\"line\" data-line=\"297\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"298\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"299\">\n</span><span class=\"line\" data-line=\"300\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"301\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"302\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"303\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"304\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"305\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"306\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"307\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"308\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"309\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"310\">\n</span><span class=\"line\" data-line=\"311\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"312\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"313\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"314\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"315\">\n</span><span class=\"line\" data-line=\"316\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"317\">\n</span><span class=\"line\" data-line=\"318\">\n</span><span class=\"line\" data-line=\"319\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">filenames</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"320\">\n</span><span class=\"line\" data-line=\"321\">    <span class=\"k\">def</span> <span class=\"nf\">add_file</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"322\">        <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"323\">        <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"324\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"325\">            <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"326\">        <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"327\">\n</span><span class=\"line\" data-line=\"328\">    <span class=\"k\">def</span> <span class=\"nf\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"329\">        <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"330\">            <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"331\">                <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"332\">                <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"333\">                <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"334\">                    <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"335\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"336\">\n</span><span class=\"line\" data-line=\"337\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"338\">        <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"339\">            <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"340\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"341\">            <span class=\"k\">elif</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"342\">                <span class=\"n\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"343\">\n</span><span class=\"line\" data-line=\"344\">\n</span><span class=\"line\" data-line=\"345\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"346\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "853cc2f82fa79cbdfb092aed004823048cee2779": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"2\">\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">defaultdict</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">from</span> <span class=\"nn\">tempfile</span> <span class=\"kn\">import</span> <span class=\"n\">NamedTemporaryFile</span> <span class=\"k\">as</span> <span class=\"n\">Temp</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">compare_trees</span> <span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">trees</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"n\">defaultdict</span> <span class=\"p\">(</span><span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"kc\">None</span><span class=\"p\">]</span> <span class=\"o\">*</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">trees</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">tree</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span> <span class=\"p\">(</span><span class=\"n\">trees</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">        <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">            <span class=\"n\">entries</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">][</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oids</span> <span class=\"ow\">in</span> <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"k\">yield</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\"><span class=\"k\">def</span> <span class=\"nf\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"k\">if</span> <span class=\"n\">o_from</span> <span class=\"o\">!=</span> <span class=\"n\">o_to</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"n\">action</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s1\">&#39;new file&#39;</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">o_from</span> <span class=\"k\">else</span>\n</span><span class=\"line\" data-line=\"23\">                      <span class=\"s1\">&#39;deleted&#39;</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">o_to</span> <span class=\"k\">else</span>\n</span><span class=\"line\" data-line=\"24\">                      <span class=\"s1\">&#39;modified&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"k\">yield</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\"><span class=\"k\">def</span> <span class=\"nf\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_from</span><span class=\"p\">,</span> <span class=\"n\">t_to</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"k\">if</span> <span class=\"n\">o_from</span> <span class=\"o\">!=</span> <span class=\"n\">o_to</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"32\">            <span class=\"n\">output</span> <span class=\"o\">+=</span> <span class=\"n\">diff_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\"><span class=\"k\">def</span> <span class=\"nf\">diff_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">o_to</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">with</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_from</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_to</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"k\">for</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"p\">((</span><span class=\"n\">o_from</span><span class=\"p\">,</span> <span class=\"n\">f_from</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_to</span><span class=\"p\">,</span> <span class=\"n\">f_to</span><span class=\"p\">)):</span>\n</span><span class=\"line\" data-line=\"39\">            <span class=\"k\">if</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"40\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"41\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">        <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"44\">            <span class=\"p\">[</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--unified&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--show-c-function&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"45\">             <span class=\"s1\">&#39;--label&#39;</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;a/</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_from</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"46\">             <span class=\"s1\">&#39;--label&#39;</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;b/</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_to</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"47\">            <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"48\">            <span class=\"n\">output</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\"><span class=\"k\">def</span> <span class=\"nf\">merge_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span> <span class=\"ow\">in</span> <span class=\"n\">compare_trees</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"n\">tree</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"57\">    <span class=\"k\">return</span> <span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">merge_blobs</span> <span class=\"p\">(</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">o_other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">with</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_base</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_HEAD</span><span class=\"p\">,</span> <span class=\"n\">Temp</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">f_other</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">        <span class=\"c1\"># Write blobs to files</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"k\">for</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"p\">((</span><span class=\"n\">o_base</span><span class=\"p\">,</span> <span class=\"n\">f_base</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_HEAD</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"p\">),</span> <span class=\"p\">(</span><span class=\"n\">o_other</span><span class=\"p\">,</span> <span class=\"n\">f_other</span><span class=\"p\">)):</span>\n</span><span class=\"line\" data-line=\"65\">            <span class=\"k\">if</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"67\">                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\">        <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"p\">[</span><span class=\"s1\">&#39;diff3&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"71\">             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_HEAD</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"72\">             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;BASE&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_base</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"73\">             <span class=\"s1\">&#39;-L&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">f_other</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"74\">            <span class=\"p\">],</span> <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"75\">            <span class=\"n\">output</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"76\">            <span class=\"k\">assert</span> <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">returncode</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">        <span class=\"k\">return</span> <span class=\"n\">output</span>\n</span></code></pre></div>\n", "c9a0a111473ac49b6956fc6dc6f472eed8e34790": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"s1\">&#39;refs/heads/master&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"15\">\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"c1\"># Index is flat, we need it as a tree of dicts</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">index_as_tree</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">        <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"n\">dirpath</span><span class=\"p\">,</span> <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">path</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">index_as_tree</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"c1\"># Find the dict for the directory of this file</span>\n</span><span class=\"line\" data-line=\"27\">            <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirpath</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">                <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">current</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">,</span> <span class=\"p\">{})</span>\n</span><span class=\"line\" data-line=\"29\">            <span class=\"n\">current</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">def</span> <span class=\"nf\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">tree_dict</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"32\">        <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"33\">        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">tree_dict</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"34\">            <span class=\"k\">if</span> <span class=\"nb\">type</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"nb\">dict</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"36\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">            <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"38\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"39\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"40\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">        <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"43\">                        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"44\">                        <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">\n</span><span class=\"line\" data-line=\"47\">    <span class=\"k\">return</span> <span class=\"n\">write_tree_recursive</span> <span class=\"p\">(</span><span class=\"n\">index_as_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"55\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"63\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"65\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"67\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"68\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"70\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">get_working_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"78\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"80\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"81\">            <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"82\">                <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">get_index_tree</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"88\">        <span class=\"k\">return</span> <span class=\"n\">index</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">dirnames</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">,</span> <span class=\"n\">topdown</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"94\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"97\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"98\">        <span class=\"k\">for</span> <span class=\"n\">dirname</span> <span class=\"ow\">in</span> <span class=\"n\">dirnames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"99\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">dirname</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"101\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"102\">            <span class=\"k\">try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"103\">                <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">rmdir</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">FileNotFoundError</span><span class=\"p\">,</span> <span class=\"ne\">OSError</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"105\">                <span class=\"c1\"># Deletion might fail if the directory contains ignored files,</span>\n</span><span class=\"line\" data-line=\"106\">                <span class=\"c1\"># so it&#39;s OK</span>\n</span><span class=\"line\" data-line=\"107\">                <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">clear</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"113\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">        <span class=\"k\">if</span> <span class=\"n\">update_working</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\">            <span class=\"n\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\"><span class=\"k\">def</span> <span class=\"nf\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">,</span> <span class=\"n\">t_HEAD</span><span class=\"p\">,</span> <span class=\"n\">t_other</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">clear</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"122\">        <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">merge_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"123\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_base</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"124\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_HEAD</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"125\">            <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">t_other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"126\">        <span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">        <span class=\"k\">if</span> <span class=\"n\">update_working</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"129\">            <span class=\"n\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"130\">\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\"><span class=\"k\">def</span> <span class=\"nf\">_checkout_index</span> <span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"133\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"135\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;./</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"137\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"138\">\n</span><span class=\"line\" data-line=\"139\">\n</span><span class=\"line\" data-line=\"140\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"141\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"144\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"145\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"148\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"149\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">delete_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"150\">\n</span><span class=\"line\" data-line=\"151\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"153\">\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">\n</span><span class=\"line\" data-line=\"156\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"157\">\n</span><span class=\"line\" data-line=\"158\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\">\n</span><span class=\"line\" data-line=\"161\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"162\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"163\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"165\">\n</span><span class=\"line\" data-line=\"166\">    <span class=\"k\">if</span> <span class=\"n\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"167\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"169\">        <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"170\">\n</span><span class=\"line\" data-line=\"171\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"172\">\n</span><span class=\"line\" data-line=\"173\">\n</span><span class=\"line\" data-line=\"174\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"175\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"176\">\n</span><span class=\"line\" data-line=\"177\">\n</span><span class=\"line\" data-line=\"178\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"179\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"180\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span>\n</span><span class=\"line\" data-line=\"181\">    <span class=\"n\">merge_base</span> <span class=\"o\">=</span> <span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"182\">    <span class=\"n\">c_other</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\">    <span class=\"c1\"># Handle fast-forward merge</span>\n</span><span class=\"line\" data-line=\"185\">    <span class=\"k\">if</span> <span class=\"n\">merge_base</span> <span class=\"o\">==</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"186\">        <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"187\">        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"188\">                         <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"189\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Fast-forward merge, no need to commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"190\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"191\">\n</span><span class=\"line\" data-line=\"192\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"193\">\n</span><span class=\"line\" data-line=\"194\">    <span class=\"n\">c_base</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"195\">    <span class=\"n\">c_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"196\">    <span class=\"n\">read_tree_merged</span> <span class=\"p\">(</span><span class=\"n\">c_base</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_HEAD</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">c_other</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">update_working</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"197\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Merged in working tree</span><span class=\"se\">\\n</span><span class=\"s1\">Please commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"198\">\n</span><span class=\"line\" data-line=\"199\">\n</span><span class=\"line\" data-line=\"200\"><span class=\"k\">def</span> <span class=\"nf\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">oid1</span><span class=\"p\">,</span> <span class=\"n\">oid2</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"201\">    <span class=\"n\">parents1</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid1</span><span class=\"p\">}))</span>\n</span><span class=\"line\" data-line=\"202\">\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">oid2</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">parents1</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"205\">            <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"206\">\n</span><span class=\"line\" data-line=\"207\">\n</span><span class=\"line\" data-line=\"208\"><span class=\"k\">def</span> <span class=\"nf\">is_ancestor_of</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">maybe_ancestor</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"209\">    <span class=\"k\">return</span> <span class=\"n\">maybe_ancestor</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">commit</span><span class=\"p\">})</span>\n</span><span class=\"line\" data-line=\"210\">\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"214\">\n</span><span class=\"line\" data-line=\"215\">\n</span><span class=\"line\" data-line=\"216\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">RefValue</span> <span class=\"p\">(</span><span class=\"n\">symbolic</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"218\">\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\"><span class=\"k\">def</span> <span class=\"nf\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"221\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"222\">        <span class=\"k\">yield</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"223\">\n</span><span class=\"line\" data-line=\"224\">\n</span><span class=\"line\" data-line=\"225\"><span class=\"k\">def</span> <span class=\"nf\">is_branch</span> <span class=\"p\">(</span><span class=\"n\">branch</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"226\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"227\">\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\"><span class=\"k\">def</span> <span class=\"nf\">get_branch_name</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"231\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"232\">        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"233\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"234\">    <span class=\"k\">assert</span> <span class=\"n\">HEAD</span><span class=\"o\">.</span><span class=\"n\">startswith</span> <span class=\"p\">(</span><span class=\"s1\">&#39;refs/heads/&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">,</span> <span class=\"s1\">&#39;refs/heads&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\">\n</span><span class=\"line\" data-line=\"238\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parents&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"239\">\n</span><span class=\"line\" data-line=\"240\">\n</span><span class=\"line\" data-line=\"241\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"242\">    <span class=\"n\">parents</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"245\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"246\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"247\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"248\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"249\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"250\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"251\">            <span class=\"n\">parents</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"252\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"253\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"254\">\n</span><span class=\"line\" data-line=\"255\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"256\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"n\">parents</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"257\">\n</span><span class=\"line\" data-line=\"258\">\n</span><span class=\"line\" data-line=\"259\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"260\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"261\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"262\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"263\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"264\">\n</span><span class=\"line\" data-line=\"265\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"266\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"267\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"268\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"269\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"270\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"271\">\n</span><span class=\"line\" data-line=\"272\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"273\">        <span class=\"c1\"># Return first parent next</span>\n</span><span class=\"line\" data-line=\"274\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"275\">        <span class=\"c1\"># Return other parents later</span>\n</span><span class=\"line\" data-line=\"276\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:])</span>\n</span><span class=\"line\" data-line=\"277\">\n</span><span class=\"line\" data-line=\"278\">\n</span><span class=\"line\" data-line=\"279\"><span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_commits</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"280\">    <span class=\"c1\"># N.B. Must yield the oid before acccessing it (to allow caller to fetch it</span>\n</span><span class=\"line\" data-line=\"281\">    <span class=\"c1\"># if needed)</span>\n</span><span class=\"line\" data-line=\"282\">\n</span><span class=\"line\" data-line=\"283\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"284\">    <span class=\"k\">def</span> <span class=\"nf\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"285\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"286\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"287\">        <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"288\">            <span class=\"k\">if</span> <span class=\"n\">oid</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"289\">                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"290\">                    <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"291\">                <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"292\">                    <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"293\">                    <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"294\">\n</span><span class=\"line\" data-line=\"295\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"296\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"297\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"298\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"299\">            <span class=\"k\">yield from</span> <span class=\"n\">iter_objects_in_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"300\">\n</span><span class=\"line\" data-line=\"301\">\n</span><span class=\"line\" data-line=\"302\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"303\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"304\">\n</span><span class=\"line\" data-line=\"305\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"306\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"307\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"308\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"309\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"310\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"311\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"312\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"313\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"314\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"315\">\n</span><span class=\"line\" data-line=\"316\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"317\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"318\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"319\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"320\">\n</span><span class=\"line\" data-line=\"321\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"322\">\n</span><span class=\"line\" data-line=\"323\">\n</span><span class=\"line\" data-line=\"324\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">filenames</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"325\">\n</span><span class=\"line\" data-line=\"326\">    <span class=\"k\">def</span> <span class=\"nf\">add_file</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"327\">        <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"328\">        <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"329\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"330\">            <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"331\">        <span class=\"n\">index</span><span class=\"p\">[</span><span class=\"n\">filename</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"332\">\n</span><span class=\"line\" data-line=\"333\">    <span class=\"k\">def</span> <span class=\"nf\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"334\">        <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"n\">dirname</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"335\">            <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"336\">                <span class=\"c1\"># Normalize path</span>\n</span><span class=\"line\" data-line=\"337\">                <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"338\">                <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"339\">                    <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"340\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"341\">\n</span><span class=\"line\" data-line=\"342\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_index</span> <span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"343\">        <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"344\">            <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"345\">                <span class=\"n\">add_file</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"346\">            <span class=\"k\">elif</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"347\">                <span class=\"n\">add_directory</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"348\">\n</span><span class=\"line\" data-line=\"349\">\n</span><span class=\"line\" data-line=\"350\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"351\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "fcf0e98217fa0a8323a2a28edd19e8d14805f95a": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">remote</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">fetch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">fetch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">    <span class=\"n\">push_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;push&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">push</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">add_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;add&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">add</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;files&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;+&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"113\">\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">\n</span><span class=\"line\" data-line=\"120\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"121\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"122\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"123\">\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"130\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"134\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"135\">\n</span><span class=\"line\" data-line=\"136\">\n</span><span class=\"line\" data-line=\"137\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"138\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"141\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\">\n</span><span class=\"line\" data-line=\"144\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"145\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"147\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"148\">\n</span><span class=\"line\" data-line=\"149\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"150\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"151\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"152\">\n</span><span class=\"line\" data-line=\"153\">\n</span><span class=\"line\" data-line=\"154\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"155\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"156\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"157\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"160\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"161\">\n</span><span class=\"line\" data-line=\"162\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"163\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"164\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"165\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"167\">\n</span><span class=\"line\" data-line=\"168\">\n</span><span class=\"line\" data-line=\"169\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"170\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"171\">\n</span><span class=\"line\" data-line=\"172\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"173\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"174\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"175\">\n</span><span class=\"line\" data-line=\"176\">\n</span><span class=\"line\" data-line=\"177\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"178\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"179\">\n</span><span class=\"line\" data-line=\"180\">\n</span><span class=\"line\" data-line=\"181\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"182\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"183\">\n</span><span class=\"line\" data-line=\"184\">\n</span><span class=\"line\" data-line=\"185\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"186\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"187\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"188\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"189\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"190\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"192\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"193\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"194\">\n</span><span class=\"line\" data-line=\"195\">\n</span><span class=\"line\" data-line=\"196\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"197\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"198\">\n</span><span class=\"line\" data-line=\"199\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"200\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"201\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"202\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"203\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"204\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"205\">\n</span><span class=\"line\" data-line=\"206\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"207\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"209\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"210\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"213\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"214\">\n</span><span class=\"line\" data-line=\"215\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"216\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"217\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"218\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"219\">\n</span><span class=\"line\" data-line=\"220\">\n</span><span class=\"line\" data-line=\"221\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"222\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"223\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"224\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"225\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"226\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"227\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"231\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"232\">\n</span><span class=\"line\" data-line=\"233\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"234\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"235\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"236\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"237\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"238\">\n</span><span class=\"line\" data-line=\"239\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes not staged for commit:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"240\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">(),</span>\n</span><span class=\"line\" data-line=\"241\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"243\">\n</span><span class=\"line\" data-line=\"244\">\n</span><span class=\"line\" data-line=\"245\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"246\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"247\">\n</span><span class=\"line\" data-line=\"248\">\n</span><span class=\"line\" data-line=\"249\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"250\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"251\">\n</span><span class=\"line\" data-line=\"252\">\n</span><span class=\"line\" data-line=\"253\"><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"254\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"255\">\n</span><span class=\"line\" data-line=\"256\">\n</span><span class=\"line\" data-line=\"257\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"258\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"259\">\n</span><span class=\"line\" data-line=\"260\">\n</span><span class=\"line\" data-line=\"261\"><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"262\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"263\">\n</span><span class=\"line\" data-line=\"264\">\n</span><span class=\"line\" data-line=\"265\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"266\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">files</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "219bd158302acc07fe9f9e41c974234009bb97eb": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">diff</span>\n</span><span class=\"line\" data-line=\"10\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">remote</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">change_git_dir</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">        <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">show_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;show&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">show</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">show_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">diff_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;diff&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">_diff</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;--cached&#39;</span><span class=\"p\">,</span> <span class=\"n\">action</span><span class=\"o\">=</span><span class=\"s1\">&#39;store_true&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">diff_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">\n</span><span class=\"line\" data-line=\"62\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"72\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">status_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">    <span class=\"n\">status_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">reset_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;reset&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">reset</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">reset_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">merge_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"n\">merge_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">merge_base_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;merge-base&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">merge_base</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit1&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">merge_base_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit2&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">fetch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">fetch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"n\">fetch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">push_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;push&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">push</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;remote&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">push_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">add_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;add&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">add</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">add_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;files&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;+&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Initialized empty ugit repository in </span><span class=\"si\">{</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getcwd</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">\n</span><span class=\"line\" data-line=\"116\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"117\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"118\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"119\">\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"122\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"127\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"128\">\n</span><span class=\"line\" data-line=\"129\">\n</span><span class=\"line\" data-line=\"130\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"131\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"132\">\n</span><span class=\"line\" data-line=\"133\">\n</span><span class=\"line\" data-line=\"134\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"135\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"136\">\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\"><span class=\"k\">def</span> <span class=\"nf\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"n\">refs_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39; (</span><span class=\"si\">{</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">refs</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s1\">)&#39;</span> <span class=\"k\">if</span> <span class=\"n\">refs</span> <span class=\"k\">else</span> <span class=\"s1\">&#39;&#39;</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}{</span><span class=\"n\">refs_str</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"141\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"142\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"143\">\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"148\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">setdefault</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"149\">\n</span><span class=\"line\" data-line=\"150\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"151\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"152\">        <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">,</span> <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">get</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"153\">\n</span><span class=\"line\" data-line=\"154\">\n</span><span class=\"line\" data-line=\"155\"><span class=\"k\">def</span> <span class=\"nf\">show</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"156\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"157\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"160\">    <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"161\">        <span class=\"n\">parent_tree</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"162\">\n</span><span class=\"line\" data-line=\"163\">    <span class=\"n\">_print_commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"164\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"165\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">parent_tree</span><span class=\"p\">),</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"166\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"167\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"168\">\n</span><span class=\"line\" data-line=\"169\">\n</span><span class=\"line\" data-line=\"170\"><span class=\"k\">def</span> <span class=\"nf\">_diff</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"171\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"172\">\n</span><span class=\"line\" data-line=\"173\">    <span class=\"k\">if</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"174\">        <span class=\"c1\"># If a commit was provided explicitly, diff from it</span>\n</span><span class=\"line\" data-line=\"175\">        <span class=\"n\">tree_from</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"176\">\n</span><span class=\"line\" data-line=\"177\">    <span class=\"k\">if</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">cached</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"178\">        <span class=\"n\">tree_to</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"179\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"180\">            <span class=\"c1\"># If no commit was provided, diff from HEAD</span>\n</span><span class=\"line\" data-line=\"181\">            <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"182\">            <span class=\"n\">tree_from</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"183\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"184\">        <span class=\"n\">tree_to</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"185\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"186\">            <span class=\"c1\"># If no commit was provided, diff from index</span>\n</span><span class=\"line\" data-line=\"187\">            <span class=\"n\">tree_from</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"188\">\n</span><span class=\"line\" data-line=\"189\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">diff_trees</span> <span class=\"p\">(</span><span class=\"n\">tree_from</span><span class=\"p\">,</span> <span class=\"n\">tree_to</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"190\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"191\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"192\">\n</span><span class=\"line\" data-line=\"193\">\n</span><span class=\"line\" data-line=\"194\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"195\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"196\">\n</span><span class=\"line\" data-line=\"197\">\n</span><span class=\"line\" data-line=\"198\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"199\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"200\">\n</span><span class=\"line\" data-line=\"201\">\n</span><span class=\"line\" data-line=\"202\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"203\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"204\">        <span class=\"n\">current</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"205\">        <span class=\"k\">for</span> <span class=\"n\">branch</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_branch_names</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"206\">            <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;*&#39;</span> <span class=\"k\">if</span> <span class=\"n\">branch</span> <span class=\"o\">==</span> <span class=\"n\">current</span> <span class=\"k\">else</span> <span class=\"s1\">&#39; &#39;</span>\n</span><span class=\"line\" data-line=\"207\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">prefix</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"208\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"209\">        <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"210\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"211\">\n</span><span class=\"line\" data-line=\"212\">\n</span><span class=\"line\" data-line=\"213\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"214\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"215\">\n</span><span class=\"line\" data-line=\"216\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"217\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">(</span><span class=\"n\">deref</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"218\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"219\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"220\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">symbolic</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"221\">            <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"222\">\n</span><span class=\"line\" data-line=\"223\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"224\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"225\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"226\">        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parents</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"227\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"228\">\n</span><span class=\"line\" data-line=\"229\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"230\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"231\">\n</span><span class=\"line\" data-line=\"232\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"233\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"234\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"235\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"236\">\n</span><span class=\"line\" data-line=\"237\">\n</span><span class=\"line\" data-line=\"238\"><span class=\"k\">def</span> <span class=\"nf\">status</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"239\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span> <span class=\"p\">(</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"240\">    <span class=\"n\">branch</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_branch_name</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"241\">    <span class=\"k\">if</span> <span class=\"n\">branch</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"242\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;On branch </span><span class=\"si\">{</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"243\">    <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"244\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;HEAD detached at </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"245\">\n</span><span class=\"line\" data-line=\"246\">    <span class=\"n\">MERGE_HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;MERGE_HEAD&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"247\">    <span class=\"k\">if</span> <span class=\"n\">MERGE_HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"248\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Merging with </span><span class=\"si\">{</span><span class=\"n\">MERGE_HEAD</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"249\">\n</span><span class=\"line\" data-line=\"250\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes to be committed:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"251\">    <span class=\"n\">HEAD_tree</span> <span class=\"o\">=</span> <span class=\"n\">HEAD</span> <span class=\"ow\">and</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">HEAD</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">tree</span>\n</span><span class=\"line\" data-line=\"252\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">HEAD_tree</span><span class=\"p\">),</span>\n</span><span class=\"line\" data-line=\"253\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"254\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"255\">\n</span><span class=\"line\" data-line=\"256\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">Changes not staged for commit:</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"257\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">action</span> <span class=\"ow\">in</span> <span class=\"n\">diff</span><span class=\"o\">.</span><span class=\"n\">iter_changed_files</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_index_tree</span> <span class=\"p\">(),</span>\n</span><span class=\"line\" data-line=\"258\">                                                 <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_working_tree</span> <span class=\"p\">()):</span>\n</span><span class=\"line\" data-line=\"259\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">action</span><span class=\"si\">:</span><span class=\"s1\">&gt;12</span><span class=\"si\">}</span><span class=\"s1\">: </span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"260\">\n</span><span class=\"line\" data-line=\"261\">\n</span><span class=\"line\" data-line=\"262\"><span class=\"k\">def</span> <span class=\"nf\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"263\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">reset</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"264\">\n</span><span class=\"line\" data-line=\"265\">\n</span><span class=\"line\" data-line=\"266\"><span class=\"k\">def</span> <span class=\"nf\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"267\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">merge</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"268\">\n</span><span class=\"line\" data-line=\"269\">\n</span><span class=\"line\" data-line=\"270\"><span class=\"k\">def</span> <span class=\"nf\">merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"271\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_merge_base</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit1</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">commit2</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"272\">\n</span><span class=\"line\" data-line=\"273\">\n</span><span class=\"line\" data-line=\"274\"><span class=\"k\">def</span> <span class=\"nf\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"275\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">fetch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"276\">\n</span><span class=\"line\" data-line=\"277\">\n</span><span class=\"line\" data-line=\"278\"><span class=\"k\">def</span> <span class=\"nf\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"279\">    <span class=\"n\">remote</span><span class=\"o\">.</span><span class=\"n\">push</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">remote</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">branch</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"280\">\n</span><span class=\"line\" data-line=\"281\">\n</span><span class=\"line\" data-line=\"282\"><span class=\"k\">def</span> <span class=\"nf\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"283\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">files</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}}